<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Gaussli&#39;s Blog</title>
  
  <subtitle>Learn More Everyday</subtitle>
  <link href="https://gaussli.com/atom.xml" rel="self"/>
  
  <link href="https://gaussli.com/"/>
  <updated>2024-12-09T15:55:44.701Z</updated>
  <id>https://gaussli.com/</id>
  
  <author>
    <name>gaussli</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>【Kubernetes】pod的QoS</title>
    <link href="https://gaussli.com/2024/12/07/%E3%80%90kubernetes%E3%80%91pod%E7%9A%84qos/"/>
    <id>https://gaussli.com/2024/12/07/%E3%80%90kubernetes%E3%80%91pod%E7%9A%84qos/</id>
    <published>2024-12-07T04:02:01.000Z</published>
    <updated>2024-12-09T15:55:44.701Z</updated>
    
    <content type="html"><![CDATA[<p><code>QoS</code>，全称<code>Quality of Service</code>，中文称为<code>服务质量</code>。<code>Kubernetes</code>依赖这个来确认当节点不够资源时，哪些<code>pod</code>优先被驱逐。当节点出现资源压力而触发驱逐动作时，只有超过了配置的request的资源可能会被驱逐。</p><p><code>Qos</code>分为以下3种：</p><ul><li>Guaranteed<ul><li>这些<code>pod</code>最后被驱逐。</li><li>这些<code>pod</code>能通过cpu管理策略（CPU management policy）中的静态（static）策略来使用独占cpu。</li><li>标准：<ul><li><code>pod</code>所有容器必须有memory limit和request配置</li><li>所有容器的memory limit必须等于memory request</li><li>所有容器必须有cpu limit和request配置</li><li>所有容器的cpu limit必须等于cpu request</li></ul></li></ul></li><li>Burstable<ul><li>这些<code>pod</code>优先于<code>Guaranteed</code>被驱逐。</li><li>标准：<ul><li>不满足<code>Guaranteed</code>的标准</li><li>至少一个容器有memory或cpu的request或limit配置。</li></ul></li></ul></li><li>BestEffort<ul><li>这些<code>pod</code>最优先被驱逐。</li><li>无限制是有node节点的memory和cpu资源。</li><li>标准；<ul><li>不满足<code>Guaranteed</code>和<code>Burstable</code>的标准。</li><li>所有容器都没有配置memory和cpu的request和limit。</li></ul></li></ul></li></ul><p>Memory QoS使用cgroup v2的内存管理控制器（<code>memory controller</code>），<code>v1.22</code>版本中处于<code>Alpha</code>阶段并且默认为false不开启。这里使用cgroup v2的内存管理控制器的<code>memory.min</code>来处理容器中的memory request的值，使用<code>memory.high</code>来处理容器中的memory limit的值。</p><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;code&gt;QoS&lt;/code&gt;，全称&lt;code&gt;Quality of Service&lt;/code&gt;，中文称为&lt;code&gt;服务质量&lt;/code&gt;。&lt;code&gt;Kubernetes&lt;/code&gt;依赖这个来确认当节点不够资源时，哪些&lt;code&gt;pod&lt;/code&gt;优先被驱逐。当</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/kubernetes/"/>
    
    <category term="Pod" scheme="https://gaussli.com/categories/tech/kubernetes/pod/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="Pod" scheme="https://gaussli.com/tags/pod/"/>
    
    <category term="QoS" scheme="https://gaussli.com/tags/qos/"/>
    
    <category term="服务质量" scheme="https://gaussli.com/tags/%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/"/>
    
  </entry>
  
  <entry>
    <title>【Kubernetes】pod的优先级</title>
    <link href="https://gaussli.com/2024/12/06/%E3%80%90kubernetes%E3%80%91pod%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7/"/>
    <id>https://gaussli.com/2024/12/06/%E3%80%90kubernetes%E3%80%91pod%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7/</id>
    <published>2024-12-05T17:51:26.000Z</published>
    <updated>2024-12-06T15:40:31.500Z</updated>
    
    <content type="html"><![CDATA[<p>在<code>Kubernetes</code>中，支持给<code>pod</code>配置更高的优先级属性，使pod的重要程度提升，从而降低被驱逐的可能。特别地，可以用在一些<code>Kubernetes</code>关键组件的<code>pod</code>上，如<code>metrics-server</code>、<code>DNS</code>等服务，毕竟这些服务一旦出现异常，可能会导致<code>Kubernetes</code>部分功能不可用。</p><p>而配置<code>pod</code>的优先级，使用的是<code>PriorityClassName</code>资源，模版如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">schedule.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PriorityClassName</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">value:</span> <span class="number">1000</span> <span class="comment"># 数值越大，表明优先级越高</span></span><br><span class="line"><span class="attr">globalDefault:</span> <span class="literal">false</span> <span class="comment"># 全局默认优先级，一个Kubernetes集群只能有一个为true的PriorityClassName</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">xxx</span></span><br></pre></td></tr></table></figure><p>在<code>pod</code>中指定<code>PriorityClassName</code>资源，从而配置<code>pod</code>的优先级属性</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">xxx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">xxx</span></span><br><span class="line">  <span class="attr">priorityClassName:</span> <span class="string">xxx</span> <span class="comment"># 指定PriorityClassName的metadata.name，此属性缺省表明pod优先级为0（即最低优先级）</span></span><br></pre></td></tr></table></figure><p>默认地，<code>Kubernetes</code>初始会有两个PriorityClassName资源</p><ul><li><p>system-cluster-critical<br>用于系统关键的<code>pod</code>，<code>Kubernetes</code>系统运行依赖这些<code>pod</code>。</p></li><li><p>system-node-critical:<br>用于节点关键的<code>pod</code>，节点运行依赖这些<code>pod</code>，优先级会比<code>system-cluster-critical</code>更高，因为<code>Kubernetes</code>系统的正常运行首要条件是节点正常，即只有在节点关键<code>pod</code>正常运行，系统关键<code>pod</code>运行才有意义。</p></li></ul><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;在&lt;code&gt;Kubernetes&lt;/code&gt;中，支持给&lt;code&gt;pod&lt;/code&gt;配置更高的优先级属性，使pod的重要程度提升，从而降低被驱逐的可能。特别地，可以用在一些&lt;code&gt;Kubernetes&lt;/code&gt;关键组件的&lt;code&gt;pod&lt;/code&gt;上，如&lt;</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/kubernetes/"/>
    
    <category term="Pod" scheme="https://gaussli.com/categories/tech/kubernetes/pod/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="关键pod" scheme="https://gaussli.com/tags/%E5%85%B3%E9%94%AEpod/"/>
    
    <category term="priorityClassName" scheme="https://gaussli.com/tags/priorityclassname/"/>
    
    <category term="优先级" scheme="https://gaussli.com/tags/%E4%BC%98%E5%85%88%E7%BA%A7/"/>
    
  </entry>
  
  <entry>
    <title>【Kubernetes】关闭节点</title>
    <link href="https://gaussli.com/2024/12/06/%E3%80%90kubernetes%E3%80%91%E5%85%B3%E9%97%AD%E8%8A%82%E7%82%B9/"/>
    <id>https://gaussli.com/2024/12/06/%E3%80%90kubernetes%E3%80%91%E5%85%B3%E9%97%AD%E8%8A%82%E7%82%B9/</id>
    <published>2024-12-05T17:23:27.000Z</published>
    <updated>2024-12-06T15:40:23.573Z</updated>
    
    <content type="html"><![CDATA[<p>在Kubernetes中，节点可以分为优雅关闭（<code>Graceful node shutdown</code>）及非优雅关闭（<code>Non-graceful node shutdown</code>）。优雅关闭可以理解为有计划的关闭节点；而非优雅关闭，一般就出现在断电或一些集群外在因素导致节点所在宿主机异常。</p><h1 id="优雅关闭（Graceful-node-shutdown）"><a href="#优雅关闭（Graceful-node-shutdown）" class="headerlink" title="优雅关闭（Graceful node shutdown）"></a>优雅关闭（Graceful node shutdown）</h1><p><code>kubelet</code>会去检测os系统的关机事件，并且终结节点上的所有<code>pod</code>。此外，节点也不再接收新的<code>pod</code>创建请求。</p><p>节点优雅关闭功能开始于<code>v1.21</code>版本的特性<code>GracefulNodeShutdown</code>，此特性默认为<code>true</code>。</p><p>一旦<code>kubelet</code>检测到os系统的关机事件，则会把节点状态改为<code>NotReady</code>，且<code>reason</code>配置为<code>node is shutting down</code>。此时，kube-scheduler发现这个节点状态，将不再调度<code>pod</code>到该节点。而且，<code>kubelet</code>会在<code>PodAdmission</code>阶段拒绝<code>pod</code>的相关请求，即使<code>pod</code>打上了<code>node.kubernetes.io/not-ready:NoSchedule</code>的容忍。接着<code>kubelet</code>会驱逐节点上的所有<code>pod</code>.</p><p>一般地，节点优雅关闭受限于以下2个配置参数，参数配置为<code>0</code>时，则不启动节点优雅关闭功能</p><ul><li><p>shutdownGracePeriod<br>控制优雅关闭节点的时间</p></li><li><p>shutdownGracePeriodCriticalPods<br>控制优雅关闭关键<code>pod</code>的时间，该时间要比<code>shutdownGracePeriod</code>小。这里，非关键<code>pod</code>会比关键<code>pod</code>更快驱逐。</p><blockquote><a href="/2024/12/06/%E3%80%90kubernetes%E3%80%91pod%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7/" title="【Kubernetes】pod的优先级">如何定义关键pod</a></blockquote></li></ul><p>此外，还有一种更细粒度控制节点优雅关闭的能力，基于<code>kubelet configuration</code>文件配置<code>shutdownGracePeriodByPodPriority</code>，这个是基于<code>pod</code>优先级来控制<code>pod</code>的驱逐顺序。此能力需要<code>kubelet</code>打开名为<code>GracefulNodeShutdownBaseOnPodPriority</code>的<code>feature gate</code>，此<code>feature gate</code>在版本<code>v1.23</code>进入<code>Alpha</code>阶段，在版本<code>v1.31</code>进入<code>Beta</code>阶段并默认配置为<code>enabled</code>。</p><p>具体的配置示例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">shutdownGracePeriodByPodPriority:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">priority:</span> <span class="number">10000</span></span><br><span class="line">    <span class="attr">shutdownGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">priority:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">shutdownGracePeriodSeconds:</span> <span class="number">180</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">priority:</span> <span class="number">100</span></span><br><span class="line">    <span class="attr">shutdownGracePeriodSeconds:</span> <span class="number">120</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">priority:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">shutdownGracePeriodSeconds:</span> <span class="number">60</span></span><br></pre></td></tr></table></figure><p><code>kubelet</code>监控指标，用于提供节点关闭的指标数据</p><ul><li>graceful_shutdown_start_time_seconds</li><li>graceful_shutdown_end_time_seconds</li></ul><h1 id="非优雅关闭（Non-graceful-node-shutdown）"><a href="#非优雅关闭（Non-graceful-node-shutdown）" class="headerlink" title="非优雅关闭（Non-graceful node shutdown）"></a>非优雅关闭（Non-graceful node shutdown）</h1><p>在非优雅关闭的场景下，节点上的<code>StatefulSet</code>的<code>pod</code>会转变为<code>terminating</code>状态，但<code>pod</code>不会被delete以及不会调度重新运行一个新的。这是因为在非优雅关闭的场景下，<code>kubelet</code>无法感知关闭事件，并作出正确的<code>delete</code>操作。与此同时，如果<code>pod</code>关联了存储卷，该存储卷也无法完成解绑。所以这会导致<code>StatefulSet</code>应用无法提供正常的服务。</p><p>要解决上述的问题，<code>Kubernetes</code>已经无法自动完成处理，需要引入人工操作。在<code>kube-controller-manager</code>打开<code>NodeOutOfServiceVolumeDetach</code>的特性下，可以通过给节点打上污点：<code>node.kubernetes.io/out-of-service</code>，来表明节点已经无法提供服务了。此时当节点被非优雅关闭了，<code>pod</code>能直接自动被强制删除，并且关联存储卷也会被立即解绑，从而触发新的<code>pod</code>在其他节点重新拉起，<code>StatefulSet</code>重新提供正常的服务。</p><p>随后，一旦节点回复运行后，需要手动移除节点上<code>node.kubernetes.io/out-of-service</code>的污点，<code>pod</code>才会正常地再调度到此节点上。</p><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;在Kubernetes中，节点可以分为优雅关闭（&lt;code&gt;Graceful node shutdown&lt;/code&gt;）及非优雅关闭（&lt;code&gt;Non-graceful node shutdown&lt;/code&gt;）。优雅关闭可以理解为有计划的关闭节点；而非优雅关闭，一般就出</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/kubernetes/"/>
    
    <category term="Node" scheme="https://gaussli.com/categories/tech/kubernetes/node/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="Node" scheme="https://gaussli.com/tags/node/"/>
    
    <category term="shutdown" scheme="https://gaussli.com/tags/shutdown/"/>
    
    <category term="graceful" scheme="https://gaussli.com/tags/graceful/"/>
    
  </entry>
  
  <entry>
    <title>【CentOS】yum工具问题</title>
    <link href="https://gaussli.com/2022/04/19/%E3%80%90centos%E3%80%91yum%E5%B7%A5%E5%85%B7%E9%97%AE%E9%A2%98/"/>
    <id>https://gaussli.com/2022/04/19/%E3%80%90centos%E3%80%91yum%E5%B7%A5%E5%85%B7%E9%97%AE%E9%A2%98/</id>
    <published>2022-04-19T15:56:47.000Z</published>
    <updated>2022-04-19T16:05:01.552Z</updated>
    
    <content type="html"><![CDATA[<h1 id="BDB1507-Thread-died-in-Berkeley-DB-library"><a href="#BDB1507-Thread-died-in-Berkeley-DB-library" class="headerlink" title="BDB1507 Thread died in Berkeley DB library"></a>BDB1507 Thread died in Berkeley DB library</h1><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>yum搜索、安装或更新时报错，看意思是数据库出错。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">错误：rpmdb: BDB0113 Thread/process 19822/139881366214720 failed: BDB1507 Thread died in Berkeley DB library</span><br><span class="line">错误：db5 错误(-30973) 来自 dbenv-&gt;failchk：BDB0087 DB_RUNRECOVERY: Fatal error, run database recovery</span><br><span class="line">错误：无法使用 db5 -  (-30973) 打开 Packages 索引</span><br><span class="line">错误：无法从 /var/lib/rpm 打开软件包数据库</span><br><span class="line">CRITICAL:yum.main:</span><br><span class="line"></span><br><span class="line">Error: rpmdb open failed</span><br></pre></td></tr></table></figure><p>如图<br><img src="/2022/04/19/%E3%80%90centos%E3%80%91yum%E5%B7%A5%E5%85%B7%E9%97%AE%E9%A2%98/1.png"></p><h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><ol><li><p>删除yum临时库文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -fr /var/lib/rpm/__db.*</span><br></pre></td></tr></table></figure></li><li><p>重建rpm数据库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm –rebuilddb</span><br></pre></td></tr></table></figure></li><li><p>清理缓存及生产yumdb缓存</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure></li></ol><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;BDB1507-Thread-died-in-Berkeley-DB-library&quot;&gt;&lt;a href=&quot;#BDB1507-Thread-died-in-Berkeley-DB-library&quot; class=&quot;headerlink&quot; title=&quot;BDB1507 </summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Linux" scheme="https://gaussli.com/categories/tech/linux/"/>
    
    
    <category term="CentOS" scheme="https://gaussli.com/tags/centos/"/>
    
    <category term="yum" scheme="https://gaussli.com/tags/yum/"/>
    
    <category term="Linux" scheme="https://gaussli.com/tags/linux/"/>
    
    <category term="问题" scheme="https://gaussli.com/tags/%E9%97%AE%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>【SpringCloud】版本兼容性</title>
    <link href="https://gaussli.com/2022/03/17/%E3%80%90springcloud%E3%80%91%E7%89%88%E6%9C%AC%E5%85%BC%E5%AE%B9%E6%80%A7/"/>
    <id>https://gaussli.com/2022/03/17/%E3%80%90springcloud%E3%80%91%E7%89%88%E6%9C%AC%E5%85%BC%E5%AE%B9%E6%80%A7/</id>
    <published>2022-03-17T06:48:26.000Z</published>
    <updated>2022-03-17T07:02:48.630Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://spring.io/projects/spring-cloud">SpringCloud兼容性官方说明（https://spring.io/projects/spring-cloud）</a></p><table><thead><tr><th>SpringCloud版本</th><th>SpringBoot版本</th></tr></thead><tbody><tr><td><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2021.0-Release-Notes">2021.0.x</a> aka Jubilee</td><td>2.6.x</td></tr><tr><td><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-2020.0-Release-Notes">2020.0.x</a> aka Ilford</td><td>2.4.x,2.5.x(Starting with 2020.0.3)</td></tr><tr><td><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Hoxton-Release-Notes">Hoxton</a></td><td>2.2.x,2.3.x(Starting with SR5)</td></tr><tr><td><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Greenwith-Release-Notes">Greenwith</a></td><td>2.1.x</td></tr><tr><td><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Finchley-Release-Notes">Finchley</a></td><td>2.0.x</td></tr><tr><td><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Edgware-Release-Notes">Edgware</a></td><td>1.5.x</td></tr><tr><td><a href="https://github.com/spring-cloud/spring-cloud-release/wiki/Spring-Cloud-Dalston-Release-Notes">Dalston</a></td><td>1.5.x</td></tr></tbody></table><blockquote><p>Spring Cloud Dalston, Edgware, Finchley, and Greenwich have all reached end of life status and are no longer supported.<br>Dalston, Edgware, Finchley 和 Greenwich 版本不再更新支持。</p></blockquote><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://spring.io/projects/spring-cloud&quot;&gt;SpringCloud兼容性官方说明（https://spring.io/projects/spring-cloud）&lt;/a&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="JavaWeb" scheme="https://gaussli.com/categories/tech/javaweb/"/>
    
    <category term="Spring" scheme="https://gaussli.com/categories/tech/javaweb/spring/"/>
    
    
    <category term="SpringCloud" scheme="https://gaussli.com/tags/springcloud/"/>
    
    <category term="兼容性" scheme="https://gaussli.com/tags/%E5%85%BC%E5%AE%B9%E6%80%A7/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes二进制高可用部署10-Coredns部署</title>
    <link href="https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B210-coredns%E9%83%A8%E7%BD%B2/"/>
    <id>https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B210-coredns%E9%83%A8%E7%BD%B2/</id>
    <published>2022-01-16T09:11:56.000Z</published>
    <updated>2024-12-01T08:46:07.033Z</updated>
    
    <content type="html"><![CDATA[<h1 id="零、目录"><a href="#零、目录" class="headerlink" title="零、目录"></a>零、目录</h1><ul><li><a href="/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/" title="【容器化】Kubernetes二进制高可用部署1-准备">【容器化】Kubernetes二进制高可用部署1-准备</a></li><li><a href="/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/" title="【容器化】Kubernetes二进制高可用部署2-ca根证书">【容器化】Kubernetes二进制高可用部署2-ca根证书</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署3-etcd高可用部署">【容器化】kubernetes二进制高可用部署3-etcd高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署">【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署">【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B26-kube-controller%E5%92%8Ckube-scheduler%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署">【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署">【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署8-Calico网络插件部署">【容器化】kubernetes二进制高可用部署8-Calico网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B29-flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署">【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署</a></li><li><strong><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B210-coredns%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署10-coredns部署">【容器化】kubernetes二进制高可用部署10-coredns部署</a></strong></li></ul><h1 id="一、说明"><a href="#一、说明" class="headerlink" title="一、说明"></a>一、说明</h1><p>本文将部署Kubernetes的dns服务插件-coredns</p><p><a href="https://github.com/coredns/deployment">github: https://github.com/coredns/deployment</a><br><a href="https://coredns.io/">official: https://coredns.io/</a></p><p>版本对应：</p><table><thead><tr><th>CoreDNS版本</th><th>Kubernetes版本</th></tr></thead><tbody><tr><td>v1.8.4</td><td>v1.22</td></tr><tr><td>v1.8.0</td><td>v1.21</td></tr><tr><td>v1.7.0</td><td>v1.19 v1.20</td></tr><tr><td>v1.6.7</td><td>v1.18</td></tr><tr><td>v1.6.5</td><td>v1.17</td></tr></tbody></table><h1 id="二、获取coredns的部署文件"><a href="#二、获取coredns的部署文件" class="headerlink" title="二、获取coredns的部署文件"></a>二、获取coredns的部署文件</h1><p>当前Kubernetes压缩包中已包含了一些扩展插件的部署yaml文件，其中就包括coredns的，在<code>kubernetes-src.tar.gz</code>文件中，解压出来进入<code>cluster/addons/dns/coredns</code>目录就能找到coredns相关的部署yaml文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压文件</span></span><br><span class="line">tar -C /usr/local/src/kubernetes/kubernetes-src/ -zxvf /usr/local/src/kubernetes/kubernetes-src.tar.gz</span><br><span class="line"><span class="comment"># 进入coredns相关文件目录</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/src/kubernetes/kubernetes-src/cluster/addons/dns/coredns/</span><br></pre></td></tr></table></figure><h1 id="三、参数配置"><a href="#三、参数配置" class="headerlink" title="三、参数配置"></a>三、参数配置</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改其中的文件transforms2sed.sed</span></span><br><span class="line"><span class="comment"># 把$DNS_SERVER_IP改为kubelet启动时的DNS服务IP参数，当前为169.169.0.100</span></span><br><span class="line"><span class="comment"># 把$DNS_DOMAIN改为kubelet启动时的DNS域名参数，当前为cluster.local</span></span><br><span class="line"><span class="comment"># $SERVICE_CLUSTER_IP_RANGE此值貌似没有使用，暂不用更改</span></span><br><span class="line"><span class="comment"># 把$DNS_MEMORY_LIMIT改为自己设定的pod内存limit大小，官方推荐是170Mi</span></span><br><span class="line">s/__PILLAR__DNS__SERVER__/<span class="variable">$DNS_SERVER_IP</span>/g</span><br><span class="line">s/__PILLAR__DNS__DOMAIN__/<span class="variable">$DNS_DOMAIN</span>/g</span><br><span class="line">s/__PILLAR__CLUSTER_CIDR__/<span class="variable">$SERVICE_CLUSTER_IP_RANGE</span>/g</span><br><span class="line">s/__PILLAR__DNS__MEMORY__LIMIT__/<span class="variable">$DNS_MEMORY_LIMIT</span>/g</span><br><span class="line">s/__MACHINE_GENERATED_WARNING__/Warning: This is a file generated from the base underscore template file: __SOURCE_FILENAME__/g</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行参数更新</span></span><br><span class="line">sed -f transforms2sed.sed coredns.yaml.base &gt; coredns.yaml</span><br></pre></td></tr></table></figure><h1 id="四、部署coredns服务"><a href="#四、部署coredns服务" class="headerlink" title="四、部署coredns服务"></a>四、部署coredns服务</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f coredns.yaml</span><br></pre></td></tr></table></figure><h1 id="五、验证测试"><a href="#五、验证测试" class="headerlink" title="五、验证测试"></a>五、验证测试</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看coredns的相关资源是否启动成功，包含一个coredns的deployment，一个kube-dns的service，对应一个kube-dns的endpoints</span></span><br><span class="line">kubectl get deploy,pod,svc,endpoints -A -owide</span><br></pre></td></tr></table></figure><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;零、目录&quot;&gt;&lt;a href=&quot;#零、目录&quot; class=&quot;headerlink&quot; title=&quot;零、目录&quot;&gt;&lt;/a&gt;零、目录&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%9</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="二进制" scheme="https://gaussli.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
    <category term="部署" scheme="https://gaussli.com/tags/%E9%83%A8%E7%BD%B2/"/>
    
    <category term="coredns" scheme="https://gaussli.com/tags/coredns/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes二进制高可用部署9-Flannel网络插件部署</title>
    <link href="https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B29-flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/"/>
    <id>https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B29-flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/</id>
    <published>2022-01-16T09:11:46.000Z</published>
    <updated>2024-12-01T08:46:23.359Z</updated>
    
    <content type="html"><![CDATA[<h1 id="零、目录"><a href="#零、目录" class="headerlink" title="零、目录"></a>零、目录</h1><ul><li><a href="/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/" title="【容器化】Kubernetes二进制高可用部署1-准备">【容器化】Kubernetes二进制高可用部署1-准备</a></li><li><a href="/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/" title="【容器化】Kubernetes二进制高可用部署2-ca根证书">【容器化】Kubernetes二进制高可用部署2-ca根证书</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署3-etcd高可用部署">【容器化】kubernetes二进制高可用部署3-etcd高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署">【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署">【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B26-kube-controller%E5%92%8Ckube-scheduler%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署">【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署">【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署8-Calico网络插件部署">【容器化】kubernetes二进制高可用部署8-Calico网络插件部署</a></li><li><strong><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B29-flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署">【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署</a></strong></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B210-coredns%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署10-coredns部署">【容器化】kubernetes二进制高可用部署10-coredns部署</a></li></ul><h1 id="一、说明"><a href="#一、说明" class="headerlink" title="一、说明"></a>一、说明</h1><p>本文将部署Kubernetes的网络插件Flannel</p><p>占坑</p><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;零、目录&quot;&gt;&lt;a href=&quot;#零、目录&quot; class=&quot;headerlink&quot; title=&quot;零、目录&quot;&gt;&lt;/a&gt;零、目录&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%9</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="二进制" scheme="https://gaussli.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
    <category term="部署" scheme="https://gaussli.com/tags/%E9%83%A8%E7%BD%B2/"/>
    
    <category term="cni" scheme="https://gaussli.com/tags/cni/"/>
    
    <category term="网络插件" scheme="https://gaussli.com/tags/%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6/"/>
    
    <category term="flannel" scheme="https://gaussli.com/tags/flannel/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes二进制高可用部署8-Calico网络插件部署</title>
    <link href="https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/"/>
    <id>https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/</id>
    <published>2022-01-15T22:45:53.000Z</published>
    <updated>2024-12-01T08:46:18.606Z</updated>
    
    <content type="html"><![CDATA[<h1 id="零、目录"><a href="#零、目录" class="headerlink" title="零、目录"></a>零、目录</h1><ul><li><a href="/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/" title="【容器化】Kubernetes二进制高可用部署1-准备">【容器化】Kubernetes二进制高可用部署1-准备</a></li><li><a href="/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/" title="【容器化】Kubernetes二进制高可用部署2-ca根证书">【容器化】Kubernetes二进制高可用部署2-ca根证书</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署3-etcd高可用部署">【容器化】kubernetes二进制高可用部署3-etcd高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署">【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署">【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B26-kube-controller%E5%92%8Ckube-scheduler%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署">【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署">【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署</a></li><li><strong><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署8-Calico网络插件部署">【容器化】kubernetes二进制高可用部署8-Calico网络插件部署</a></strong></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B29-flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署">【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B210-coredns%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署10-coredns部署">【容器化】kubernetes二进制高可用部署10-coredns部署</a></li></ul><h1 id="一、说明"><a href="#一、说明" class="headerlink" title="一、说明"></a>一、说明</h1><p>本文将部署Kubernetes的网络插件Calico。</p><p>文档链接：<br><a href="https://projectcalico.docs.tigera.io/about/about-calico">最新版本</a><br><a href="https://projectcalico.docs.tigera.io/archive/v3.21/about/about-calico">v3.21版本</a><br><a href="https://projectcalico.docs.tigera.io/archive/v3.20/about/about-calico">v3.20版本</a><br><a href="https://projectcalico.docs.tigera.io/archive/v3.19/about/about-calico">v3.19版本</a><br><a href="https://projectcalico.docs.tigera.io/archive/v3.18/about/about-calico">v3.18版本</a></p><p>版本对应：</p><table><thead><tr><th>Calico版本</th><th>Kubernetes版本</th></tr></thead><tbody><tr><td>v3.21</td><td>v1.20 v1.21 v1.22</td></tr><tr><td>v3.20</td><td>v1.19 v1.20 v1.21</td></tr><tr><td>v3.19</td><td>v1.19 v1.20 v1.21</td></tr><tr><td>v3.18</td><td>v1.18 v1.19 v1.20</td></tr></tbody></table><p>部署节点要求：</p><ul><li>x86-64, arm64, ppc64le, or s390x处理器</li><li>内核3.10或更新，支持系统<ul><li>RedHat Linux 7</li><li>CentOS 7</li><li>CoreOS Container Linux stable</li><li>Ubuntu 16.04</li><li>Debian 8</li></ul></li><li>Calico需要管理<code>cali*</code>的网络设备；如果开启了IPIP模式，则同时会管理<code>tunl*</code>网络设备；如果VXLAN启用，则同时会管理<code>vxlan.calico</code>网络设备</li><li>关闭防火墙及其他iptables管理工具</li></ul><h1 id="二、获取Calico-yaml文件"><a href="#二、获取Calico-yaml文件" class="headerlink" title="二、获取Calico.yaml文件"></a>二、获取Calico.yaml文件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 旧版本Calico</span></span><br><span class="line"><span class="comment"># https://docs.projectcalico.org/archive/v3.19/manifests/calico.yaml</span></span><br><span class="line"><span class="comment"># https://docs.projectcalico.org/archive/v3.20/manifests/calico.yaml</span></span><br><span class="line"><span class="comment"># https://docs.projectcalico.org/archive/v3.21/manifests/calico.yaml</span></span><br><span class="line"><span class="comment"># 最新版本Calico</span></span><br><span class="line">wget -O /usr/local/src/calico.yaml https://docs.projectcalico.org/manifests/calico.yaml</span><br></pre></td></tr></table></figure><p>或者从下方获取，版本对应为3.21.4<br><a href="calico-yaml.txt">calico.yaml</a></p><h1 id="三、修改参数"><a href="#三、修改参数" class="headerlink" title="三、修改参数"></a>三、修改参数</h1><ul><li>按需修改4223行的<code>CALICO_IPV4POOL_CIDR</code>的值，指定pod的IP范围，该值不能和节点IP以及ClusterIP范围重合。默认值为<code>192.168.0.0/16</code></li><li>按需修改4225行的<code>IP_AUTODETECTION_METHOD</code>的值，指定网卡名称。默认值为第一张网卡的名称<br><img src="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/calico2.png"></li></ul><h1 id="四、创建Calico服务"><a href="#四、创建Calico服务" class="headerlink" title="四、创建Calico服务"></a>四、创建Calico服务</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f /usr/local/src/calico.yaml</span><br></pre></td></tr></table></figure><h1 id="五、验证测试"><a href="#五、验证测试" class="headerlink" title="五、验证测试"></a>五、验证测试</h1><p>查看集群内<code>calico-kube-controllers</code>的 Deployment 和 <code>calico-node</code> 的 Daemonset 资源是否都成功处于 Running 状态。这个过程根据网络可能很慢</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system get po -owide</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/calico1.png"></p><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;零、目录&quot;&gt;&lt;a href=&quot;#零、目录&quot; class=&quot;headerlink&quot; title=&quot;零、目录&quot;&gt;&lt;/a&gt;零、目录&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%9</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="二进制" scheme="https://gaussli.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
    <category term="部署" scheme="https://gaussli.com/tags/%E9%83%A8%E7%BD%B2/"/>
    
    <category term="cni" scheme="https://gaussli.com/tags/cni/"/>
    
    <category term="calico" scheme="https://gaussli.com/tags/calico/"/>
    
    <category term="网络插件" scheme="https://gaussli.com/tags/%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes二进制高可用部署7-Kubelet和kube-Proxy部署</title>
    <link href="https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/"/>
    <id>https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/</id>
    <published>2022-01-15T20:57:26.000Z</published>
    <updated>2024-07-07T10:40:09.057Z</updated>
    
    <content type="html"><![CDATA[<h1 id="零、目录"><a href="#零、目录" class="headerlink" title="零、目录"></a>零、目录</h1><ul><li><a href="/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/" title="【容器化】Kubernetes二进制高可用部署1-准备">【容器化】Kubernetes二进制高可用部署1-准备</a></li><li><a href="/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/" title="【容器化】Kubernetes二进制高可用部署2-ca根证书">【容器化】Kubernetes二进制高可用部署2-ca根证书</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署3-etcd高可用部署">【容器化】kubernetes二进制高可用部署3-etcd高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署">【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署">【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B26-kube-controller%E5%92%8Ckube-scheduler%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署">【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署</a></li><li><strong><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署">【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署</a></strong></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署8-Calico网络插件部署">【容器化】kubernetes二进制高可用部署8-Calico网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B29-flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署">【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B210-coredns%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署10-coredns部署">【容器化】kubernetes二进制高可用部署10-coredns部署</a></li></ul><h1 id="一、说明"><a href="#一、说明" class="headerlink" title="一、说明"></a>一、说明</h1><p>本文将部署Kubernetes组件kubelet和kube-proxy</p><h1 id="二、前提"><a href="#二、前提" class="headerlink" title="二、前提"></a>二、前提</h1><ul><li>docker 已安装且 Cgroup driver 为 systemd，反正就是 docker 和 kubelet 的 Cgroup Driver 需要一致。</li><li>Kubernetes创建pod时需要一个pause的镜像，而该镜像tag默认为<code>k8s.gcr.io/pause:3.2</code>，这个镜像源<code>k8s.gcr.io</code>是 google 的，国内默认都是不能访问的，所以有以下三种方式处理这个镜像拉取失败问题：<ul><li>（推荐）docker配置国内镜像源（如阿里的<code>https://registry.cn-hangzhou.aliyuncs.com</code>），在阿里的镜像源中，pause在<code>google_containers</code>仓库中，所以需要修改下方 kubelet 的启动参数，添加 <code>--pod-infra-container-image=google_containers/pause:3.2</code></li><li>不修改docker镜像源的情况下，可修改下方 kubelet 的启动参数，添加 <code>--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2</code></li><li>从docker官方仓库拉取<code>rancher/pause:3.2</code>镜像，并使用<code>docker tag</code>修改tag为<code>k8s.gcr.io/pause:3.2</code>，不过这个方法每加一个节点就要执行一次，不建议使用。</li></ul></li></ul><h1 id="三、复制二进制文件到-usr-bin目录"><a href="#三、复制二进制文件到-usr-bin目录" class="headerlink" title="三、复制二进制文件到&#x2F;usr&#x2F;bin目录"></a>三、复制二进制文件到&#x2F;usr&#x2F;bin目录</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="built_in">cp</span> /usr/local/src/kubernetes/server/bin/kubelet /usr/bin</span><br><span class="line"><span class="built_in">cp</span> /usr/local/src/kubernetes/server/bin/kube-proxy /usr/bin</span><br></pre></td></tr></table></figure><h1 id="四、创建kubelet服务"><a href="#四、创建kubelet服务" class="headerlink" title="四、创建kubelet服务"></a>四、创建kubelet服务</h1><h2 id="创建kubelet配置文件"><a href="#创建kubelet配置文件" class="headerlink" title="创建kubelet配置文件"></a>创建kubelet配置文件</h2><p>配置文件 kubelet.conf 参数说明：</p><ul><li>–kubeconfig：设置与 API Server 连接的相关配置，可以与 kube-controller-manager 使用的 kubeconfig 文件相同。需要将相关客户端证书文件从 Master 主机复制到 Node 主机的 <code>/etc/kubernetes/pki</code> 目录下，例如 <code>ca.crt</code>、<code>client.key</code>、<code>client.crt</code>文件</li><li>–config：kubelet 配置文件，从 Kubernetes 1.10 版本开始引入，设置可以让多个 Node 共享的配置参数，例如<code>address</code>、<code>port</code>、<code>cgroupDriver</code>、<code>clusterDNS</code>、<code>clusterDomain</code>等</li><li>–hostname-override：设置本 Node 在集群中的名称，默认值为主机名，应将各 Node 设置为主机IP或域名</li><li>–network-plugin：网络插件类型，建议使用 CNI 网络插件</li></ul><p>配置文件 kubelet.config 参数说明：</p><ul><li>address：服务监听 IP 地址</li><li>port：服务监听端口号，默认值为 10250</li><li>cgroupDriver：设置为 cgroupDriver 驱动，默认值为 cgroupfs，可选项包括 systemd</li><li>clusterDNS：集群 DNS 服务的 IP 地址，例如 169.169.0.100</li><li>clusterDomain：服务 DNS 域名后缀，例如 cluster.local</li><li>authentication：设置是否允许匿名访问或者是否使用 webhook 进行鉴权</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105节点配置</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/kubelet.conf</span></span><br><span class="line"><span class="string">KUBELET_ARGS=&quot;--kubeconfig=/etc/kubernetes/kubeconfig \</span></span><br><span class="line"><span class="string">--config=/etc/kubernetes/kubelet.config \</span></span><br><span class="line"><span class="string">--hostname-override=192.168.56.105 \</span></span><br><span class="line"><span class="string">--network-plugin=cni \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes --logtostderr=false --v=0&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.56.106节点配置</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/kubelet.conf</span></span><br><span class="line"><span class="string">KUBELET_ARGS=&quot;--kubeconfig=/etc/kubernetes/kubeconfig \</span></span><br><span class="line"><span class="string">--config=/etc/kubernetes/kubelet.config \</span></span><br><span class="line"><span class="string">--hostname-override=192.168.56.106 \</span></span><br><span class="line"><span class="string">--network-plugin=cni \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes --logtostderr=false --v=0&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.56.107节点配置</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/kubelet.conf</span></span><br><span class="line"><span class="string">KUBELET_ARGS=&quot;--kubeconfig=/etc/kubernetes/kubeconfig \</span></span><br><span class="line"><span class="string">--config=/etc/kubernetes/kubelet.config \</span></span><br><span class="line"><span class="string">--hostname-override=192.168.56.107 \</span></span><br><span class="line"><span class="string">--network-plugin=cni \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes --logtostderr=false --v=0&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/kubelet.config</span></span><br><span class="line"><span class="string">kind: KubeletConfiguration</span></span><br><span class="line"><span class="string">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">address: 0.0.0.0</span></span><br><span class="line"><span class="string">port: 10250</span></span><br><span class="line"><span class="string">cgroupDriver: systemd</span></span><br><span class="line"><span class="string">clusterDNS: [&quot;169.169.0.100&quot;]</span></span><br><span class="line"><span class="string">clusterDomain: cluster.local</span></span><br><span class="line"><span class="string">authentication:</span></span><br><span class="line"><span class="string">  anonymous:</span></span><br><span class="line"><span class="string">    enabled: true</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="创建系统服务文件"><a href="#创建系统服务文件" class="headerlink" title="创建系统服务文件"></a>创建系统服务文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /usr/lib/systemd/system/kubelet.service</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes Kubelet Server</span></span><br><span class="line"><span class="string">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class="line"><span class="string">After=docker.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">EnvironmentFile=/etc/kubernetes/kubelet.conf</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kubelet \$KUBELET_ARGS</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="启动kubelet服务"><a href="#启动kubelet服务" class="headerlink" title="启动kubelet服务"></a>启动kubelet服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br></pre></td></tr></table></figure><h1 id="五、创建kube-proxy服务"><a href="#五、创建kube-proxy服务" class="headerlink" title="五、创建kube-proxy服务"></a>五、创建kube-proxy服务</h1><h2 id="创建kube-proxy配置文件"><a href="#创建kube-proxy配置文件" class="headerlink" title="创建kube-proxy配置文件"></a>创建kube-proxy配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105节点配置</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/kube-proxy.conf</span></span><br><span class="line"><span class="string">KUBE_PROXY_ARGS=&quot;--kubeconfig=/etc/kubernetes/kubeconfig \</span></span><br><span class="line"><span class="string">--hostname-override=192.168.56.105 \</span></span><br><span class="line"><span class="string">--proxy-mode=iptables \</span></span><br><span class="line"><span class="string">--logtostderr=false --log-dir=/var/log/kubernetes --v=0&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.56.106节点配置</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/kube-proxy.conf</span></span><br><span class="line"><span class="string">KUBE_PROXY_ARGS=&quot;--kubeconfig=/etc/kubernetes/kubeconfig \</span></span><br><span class="line"><span class="string">--hostname-override=192.168.56.106 \</span></span><br><span class="line"><span class="string">--proxy-mode=iptables \</span></span><br><span class="line"><span class="string">--logtostderr=false --log-dir=/var/log/kubernetes --v=0&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.56.107节点配置</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/kube-proxy.conf</span></span><br><span class="line"><span class="string">KUBE_PROXY_ARGS=&quot;--kubeconfig=/etc/kubernetes/kubeconfig \</span></span><br><span class="line"><span class="string">--hostname-override=192.168.56.107 \</span></span><br><span class="line"><span class="string">--proxy-mode=iptables \</span></span><br><span class="line"><span class="string">--logtostderr=false --log-dir=/var/log/kubernetes --v=0&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="创建系统服务文件-1"><a href="#创建系统服务文件-1" class="headerlink" title="创建系统服务文件"></a>创建系统服务文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /usr/lib/systemd/system/kube-proxy.service</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes Kube-proxy Server</span></span><br><span class="line"><span class="string">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">EnvironmentFile=/etc/kubernetes/kube-proxy.conf</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kube-proxy \$KUBE_PROXY_ARGS</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="启动kube-proxy服务"><a href="#启动kube-proxy服务" class="headerlink" title="启动kube-proxy服务"></a>启动kube-proxy服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-proxy</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-proxy</span><br></pre></td></tr></table></figure><h1 id="六、Kubernetes集群查看"><a href="#六、Kubernetes集群查看" class="headerlink" title="六、Kubernetes集群查看"></a>六、Kubernetes集群查看</h1><h2 id="复制kubelet二进制文件到-usr-bin目录"><a href="#复制kubelet二进制文件到-usr-bin目录" class="headerlink" title="复制kubelet二进制文件到&#x2F;usr&#x2F;bin目录"></a>复制kubelet二进制文件到&#x2F;usr&#x2F;bin目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /usr/local/src/kubernetes/server/bin/kubectl /usr/bin</span><br></pre></td></tr></table></figure><h2 id="查看集群节点"><a href="#查看集群节点" class="headerlink" title="查看集群节点"></a>查看集群节点</h2><p>此时所有节点状态为 NotReady 是由于还没安装网络插件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig=/etc/kubernetes/kubeconfig get nodes -owide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果不想使用--kubeconfig参数，则只需要在用户目录下创建 .kube 目录，把 /etc/kubernetes/kubeconfig 文件复制进去并命名为config</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ~/.kube</span><br><span class="line"><span class="built_in">cp</span> /etc/kubernetes/kubeconfig ~/.kube/config</span><br><span class="line">kubectl get nodes -owide</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/node1.png"></p><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;零、目录&quot;&gt;&lt;a href=&quot;#零、目录&quot; class=&quot;headerlink&quot; title=&quot;零、目录&quot;&gt;&lt;/a&gt;零、目录&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%9</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="二进制" scheme="https://gaussli.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
    <category term="部署" scheme="https://gaussli.com/tags/%E9%83%A8%E7%BD%B2/"/>
    
    <category term="kubelet" scheme="https://gaussli.com/tags/kubelet/"/>
    
    <category term="kube-proxy" scheme="https://gaussli.com/tags/kube-proxy/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes二进制高可用部署6-Kube-Controller和kube-Scheduler部署</title>
    <link href="https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B26-kube-controller%E5%92%8Ckube-scheduler%E9%83%A8%E7%BD%B2/"/>
    <id>https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B26-kube-controller%E5%92%8Ckube-scheduler%E9%83%A8%E7%BD%B2/</id>
    <published>2022-01-15T20:57:10.000Z</published>
    <updated>2024-07-07T10:40:05.021Z</updated>
    
    <content type="html"><![CDATA[<h1 id="零、目录"><a href="#零、目录" class="headerlink" title="零、目录"></a>零、目录</h1><ul><li><a href="/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/" title="【容器化】Kubernetes二进制高可用部署1-准备">【容器化】Kubernetes二进制高可用部署1-准备</a></li><li><a href="/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/" title="【容器化】Kubernetes二进制高可用部署2-ca根证书">【容器化】Kubernetes二进制高可用部署2-ca根证书</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署3-etcd高可用部署">【容器化】kubernetes二进制高可用部署3-etcd高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署">【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署">【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署</a></li><li><strong><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B26-kube-controller%E5%92%8Ckube-scheduler%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署">【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署</a></strong></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署">【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署8-Calico网络插件部署">【容器化】kubernetes二进制高可用部署8-Calico网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B29-flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署">【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B210-coredns%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署10-coredns部署">【容器化】kubernetes二进制高可用部署10-coredns部署</a></li></ul><h1 id="一、说明"><a href="#一、说明" class="headerlink" title="一、说明"></a>一、说明</h1><p>本文将部署Kubernetes组件kube-controller和kube-scheduler。</p><h1 id="二、Kubernetes客户端证书生成"><a href="#二、Kubernetes客户端证书生成" class="headerlink" title="二、Kubernetes客户端证书生成"></a>二、Kubernetes客户端证书生成</h1><p>kube-controller-manager、kube-scheduler、kubelet和kube-proxy服务作为客户端连接kube-apiserver服务，需要为它们创建客户端CA证书进行访问。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105节点执行</span></span><br><span class="line">openssl genrsa -out /etc/kubernetes/pki/client.key 2048</span><br><span class="line"><span class="comment"># 其中 -subj 参数中的 &quot;/CN&quot; 的名称可以被设置为 &quot;admin&quot;，用于标识连接 kube-apiserver 的客户端用户名称</span></span><br><span class="line">openssl req -new -key /etc/kubernetes/pki/client.key -subj <span class="string">&quot;/CN=admin&quot;</span> -out /etc/kubernetes/pki/client.csr</span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> /etc/kubernetes/pki/client.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out /etc/kubernetes/pki/client.crt -days 36500</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.106和192.168.56.107节点执行</span></span><br><span class="line">scp -r root@192.168.56.105:/etc/kubernetes/pki/client.* /etc/kubernetes/pki/</span><br></pre></td></tr></table></figure><h1 id="三、创建kubeconfig配置文件"><a href="#三、创建kubeconfig配置文件" class="headerlink" title="三、创建kubeconfig配置文件"></a>三、创建kubeconfig配置文件</h1><p>统一创建一个kubeconfig文件作为kube-controller-manager、kube-scheduler、kubelet和kube-proxy服务连接kube-apiserver服务的配置文件，也作为后续kubectl命令工具连接kube-apiserver服务的配置文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/kubeconfig</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Config</span></span><br><span class="line"><span class="string">clusters:</span></span><br><span class="line"><span class="string">- name: default</span></span><br><span class="line"><span class="string">  cluster:</span></span><br><span class="line"><span class="string">    server: https://192.168.56.250:9443</span></span><br><span class="line"><span class="string">    certificate-authority: /etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="string">users:</span></span><br><span class="line"><span class="string">- name: admin</span></span><br><span class="line"><span class="string">  user:</span></span><br><span class="line"><span class="string">    client-certificate: /etc/kubernetes/pki/client.crt</span></span><br><span class="line"><span class="string">    client-key: /etc/kubernetes/pki/client.key</span></span><br><span class="line"><span class="string">contexts:</span></span><br><span class="line"><span class="string">- context:</span></span><br><span class="line"><span class="string">    cluster: default</span></span><br><span class="line"><span class="string">    user: admin</span></span><br><span class="line"><span class="string">  name: default</span></span><br><span class="line"><span class="string">current-context: default</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h1 id="四、复制二进制文件到-usr-bin目录"><a href="#四、复制二进制文件到-usr-bin目录" class="headerlink" title="四、复制二进制文件到&#x2F;usr&#x2F;bin目录"></a>四、复制二进制文件到&#x2F;usr&#x2F;bin目录</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="built_in">cp</span> /usr/local/src/kubernetes/server/bin/kube-controller-manager /usr/bin/</span><br><span class="line"><span class="built_in">cp</span> /usr/local/src/kubernetes/server/bin/kube-scheduler /usr/bin/</span><br></pre></td></tr></table></figure><h1 id="创建kube-controller服务"><a href="#创建kube-controller服务" class="headerlink" title="创建kube-controller服务"></a>创建kube-controller服务</h1><h2 id="创建kube-controller配置文件"><a href="#创建kube-controller配置文件" class="headerlink" title="创建kube-controller配置文件"></a>创建kube-controller配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/controller-manager.conf</span></span><br><span class="line"><span class="string">KUBE_CONTROLLER_MANAGER_ARGS=&quot;--kubeconfig=/etc/kubernetes/kubeconfig \</span></span><br><span class="line"><span class="string">--leader-elect=true \</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=169.169.0.0/16 \</span></span><br><span class="line"><span class="string">--service-account-private-key-file=/etc/kubernetes/pki/apiserver.key \</span></span><br><span class="line"><span class="string">--root-ca-file=/etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes --logtostderr=false --v=0&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="创建系统服务文件"><a href="#创建系统服务文件" class="headerlink" title="创建系统服务文件"></a>创建系统服务文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /usr/lib/systemd/system/kube-controller-manager.service</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes Controller Manager</span></span><br><span class="line"><span class="string">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">EnvironmentFile=/etc/kubernetes/controller-manager.conf</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_ARGS</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="启动kube-controller服务"><a href="#启动kube-controller服务" class="headerlink" title="启动kube-controller服务"></a>启动kube-controller服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-controller-manager</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-controller-manager</span><br></pre></td></tr></table></figure><h1 id="五、创建kube-scheduler服务"><a href="#五、创建kube-scheduler服务" class="headerlink" title="五、创建kube-scheduler服务"></a>五、创建kube-scheduler服务</h1><h2 id="创建kube-scheduler配置文件"><a href="#创建kube-scheduler配置文件" class="headerlink" title="创建kube-scheduler配置文件"></a>创建kube-scheduler配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/scheduler.conf</span></span><br><span class="line"><span class="string">KUBE_SCHEDULER_ARGS=&quot;--kubeconfig=/etc/kubernetes/kubeconfig \</span></span><br><span class="line"><span class="string">--leader-elect=true \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes --logtostderr=false --v=0&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="创建系统服务文件-1"><a href="#创建系统服务文件-1" class="headerlink" title="创建系统服务文件"></a>创建系统服务文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /usr/lib/systemd/system/kube-scheduler.service</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes Scheduler</span></span><br><span class="line"><span class="string">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">EnvironmentFile=/etc/kubernetes/scheduler.conf</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kube-scheduler \$KUBE_SCHEDULER_ARGS</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="启动kube-scheduler服务"><a href="#启动kube-scheduler服务" class="headerlink" title="启动kube-scheduler服务"></a>启动kube-scheduler服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-scheduler</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-scheduler</span><br></pre></td></tr></table></figure><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;零、目录&quot;&gt;&lt;a href=&quot;#零、目录&quot; class=&quot;headerlink&quot; title=&quot;零、目录&quot;&gt;&lt;/a&gt;零、目录&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%9</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="二进制" scheme="https://gaussli.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
    <category term="部署" scheme="https://gaussli.com/tags/%E9%83%A8%E7%BD%B2/"/>
    
    <category term="kube-controller" scheme="https://gaussli.com/tags/kube-controller/"/>
    
    <category term="kube-scheduler" scheme="https://gaussli.com/tags/kube-scheduler/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes二进制高可用部署5-HA和Keepalived部署</title>
    <link href="https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/"/>
    <id>https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/</id>
    <published>2022-01-15T18:48:53.000Z</published>
    <updated>2024-07-07T10:40:00.596Z</updated>
    
    <content type="html"><![CDATA[<h1 id="零、目录"><a href="#零、目录" class="headerlink" title="零、目录"></a>零、目录</h1><ul><li><a href="/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/" title="【容器化】Kubernetes二进制高可用部署1-准备">【容器化】Kubernetes二进制高可用部署1-准备</a></li><li><a href="/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/" title="【容器化】Kubernetes二进制高可用部署2-ca根证书">【容器化】Kubernetes二进制高可用部署2-ca根证书</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署3-etcd高可用部署">【容器化】kubernetes二进制高可用部署3-etcd高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署">【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署</a></li><li><strong><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署">【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署</a></strong></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B26-kube-controller%E5%92%8Ckube-scheduler%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署">【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署">【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署8-Calico网络插件部署">【容器化】kubernetes二进制高可用部署8-Calico网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B29-flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署">【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B210-coredns%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署10-coredns部署">【容器化】kubernetes二进制高可用部署10-coredns部署</a></li></ul><h1 id="一、说明"><a href="#一、说明" class="headerlink" title="一、说明"></a>一、说明</h1><p>本文将部署HAProxy和Keepalived服务，以实现kube-apiserver服务的高可用。</p><h1 id="二、前提"><a href="#二、前提" class="headerlink" title="二、前提"></a>二、前提</h1><p>本文的HAProxy和Keepalived直接使用docker部署，所以需要提前安装好docker服务，详见：<a href="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91docker%E9%83%A8%E7%BD%B2/" title="【容器化】Docker部署">【容器化】Docker部署</a></p><p>修改cgroupdriver</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/docker/daemon.json</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span><br><span class="line"><span class="string">  &quot;log-driver&quot;: &quot;json-file&quot;,</span></span><br><span class="line"><span class="string">  &quot;log-opts&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;max-size&quot;: &quot;100m&quot;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;storage-driver&quot;: &quot;overlay2&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h1 id="三、部署HAProxy"><a href="#三、部署HAProxy" class="headerlink" title="三、部署HAProxy"></a>三、部署HAProxy</h1><h2 id="创建HAProxy配置文件"><a href="#创建HAProxy配置文件" class="headerlink" title="创建HAProxy配置文件"></a>创建HAProxy配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105和192.168.56.106节点执行</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/haproxy</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/haproxy/haproxy.cfg</span></span><br><span class="line"><span class="string">global</span></span><br><span class="line"><span class="string">    log             127.0.0.1 local2</span></span><br><span class="line"><span class="string">    chroot          /var/lib/haproxy</span></span><br><span class="line"><span class="string">    pidfile         /var/run/haproxy.pid</span></span><br><span class="line"><span class="string">    maxconn         4096</span></span><br><span class="line"><span class="string">    user            haproxy</span></span><br><span class="line"><span class="string">    group           haproxy</span></span><br><span class="line"><span class="string">    daemon</span></span><br><span class="line"><span class="string">    stats           socket          /var/lib/haproxy/stats</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">defaults</span></span><br><span class="line"><span class="string">    mode            http</span></span><br><span class="line"><span class="string">    log             global</span></span><br><span class="line"><span class="string">    option          httplog</span></span><br><span class="line"><span class="string">    option          dontlognull</span></span><br><span class="line"><span class="string">    option          http-server-close</span></span><br><span class="line"><span class="string">    option          forwardfor except 127.0.0.0/8</span></span><br><span class="line"><span class="string">    option          redispatch</span></span><br><span class="line"><span class="string">    retries         3</span></span><br><span class="line"><span class="string">    timeout http-request    10s</span></span><br><span class="line"><span class="string">    timeout queue           1m</span></span><br><span class="line"><span class="string">    timeout connect         10s</span></span><br><span class="line"><span class="string">    timeout client          1m</span></span><br><span class="line"><span class="string">    timeout server          1m</span></span><br><span class="line"><span class="string">    timeout http-keep-alive 10s</span></span><br><span class="line"><span class="string">    timeout check           10s</span></span><br><span class="line"><span class="string">    maxconn         3000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">frontend kube-apiserver</span></span><br><span class="line"><span class="string">    mode            tcp</span></span><br><span class="line"><span class="string">    bind            *:9443</span></span><br><span class="line"><span class="string">    option          tcplog</span></span><br><span class="line"><span class="string">    default_backend kube-apiserver</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">listen stats</span></span><br><span class="line"><span class="string">    mode            http</span></span><br><span class="line"><span class="string">    bind            *:8888</span></span><br><span class="line"><span class="string">    stats auth      admin:password</span></span><br><span class="line"><span class="string">    stats refresh   5s</span></span><br><span class="line"><span class="string">    stats realm     HAProxy\ Statistics</span></span><br><span class="line"><span class="string">    stats uri       /stats</span></span><br><span class="line"><span class="string">    log             127.0.0.1 local3 err</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">backend kube-apiserver</span></span><br><span class="line"><span class="string">    mode            tcp</span></span><br><span class="line"><span class="string">    balance         roundrobin</span></span><br><span class="line"><span class="string">    server k8s-master1 192.168.56.105:6443 check</span></span><br><span class="line"><span class="string">    server k8s-master2 192.168.56.106:6443 check</span></span><br><span class="line"><span class="string">    server k8s-master3 192.168.56.107:6443 check</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="基于docker部署HAProxy服务"><a href="#基于docker部署HAProxy服务" class="headerlink" title="基于docker部署HAProxy服务"></a>基于docker部署HAProxy服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105和192.168.56.106节点执行</span></span><br><span class="line">docker run -d --name k8s-haproxy \</span><br><span class="line">--net=host \</span><br><span class="line">--restart=always \</span><br><span class="line">-v /etc/haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro \</span><br><span class="line">haproxytech/haproxy-debian:2.3</span><br></pre></td></tr></table></figure><h2 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h2><p>访问：<code>http://192.168.56.105:8888/stats</code>或<code>http://192.168.56.106:8888/stats</code>，可见三个节点的状态都处于<code>UP</code>状态则为正常。<br>结果截图<br><img src="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/haproxy1.png"></p><h1 id="四、部署Keepalived服务"><a href="#四、部署Keepalived服务" class="headerlink" title="四、部署Keepalived服务"></a>四、部署Keepalived服务</h1><h2 id="创建Keepalived配置文件"><a href="#创建Keepalived配置文件" class="headerlink" title="创建Keepalived配置文件"></a>创建Keepalived配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105节点执行</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/keepalived</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/keepalived/keepalived.conf</span></span><br><span class="line"><span class="string">! Configuration File for keepalived</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">global_defs &#123;</span></span><br><span class="line"><span class="string">  router_id LVS_1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vrrp_script checkhaproxy &#123;</span></span><br><span class="line"><span class="string">  script &quot;/usr/bin/check-haproxy.sh&quot;</span></span><br><span class="line"><span class="string">  interval 2</span></span><br><span class="line"><span class="string">  weight -30</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vrrp_instance VI_1 &#123;</span></span><br><span class="line"><span class="string">  state MASTER</span></span><br><span class="line"><span class="string">  interface enp0s8</span></span><br><span class="line"><span class="string">  virtual_router_id 51</span></span><br><span class="line"><span class="string">  priority 100</span></span><br><span class="line"><span class="string">  advert_int 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  virtual_ipaddress &#123;</span></span><br><span class="line"><span class="string">    192.168.56.250/24 dev enp0s8</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  authentication &#123;</span></span><br><span class="line"><span class="string">    auth_type PASS</span></span><br><span class="line"><span class="string">    auth_pass password</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  track_script &#123;</span></span><br><span class="line"><span class="string">    checkhaproxy</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/keepalived/check-haproxy.sh</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">count=\`netstat -apn | grep 9443 | wc -l\`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if [ $count -gt 0 ]; then</span></span><br><span class="line"><span class="string">  exit 0</span></span><br><span class="line"><span class="string">else </span></span><br><span class="line"><span class="string">  exit 1</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.106节点执行</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/keepalived</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/keepalived/keepalived.conf</span></span><br><span class="line"><span class="string">! Configuration File for keepalived</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">global_defs &#123;</span></span><br><span class="line"><span class="string">  router_id LVS_2</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vrrp_script checkhaproxy &#123;</span></span><br><span class="line"><span class="string">  script &quot;/usr/bin/check-haproxy.sh&quot;</span></span><br><span class="line"><span class="string">  interval 2</span></span><br><span class="line"><span class="string">  weight -30</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">vrrp_instance VI_1 &#123;</span></span><br><span class="line"><span class="string">  state BACKUP</span></span><br><span class="line"><span class="string">  interface enp0s8</span></span><br><span class="line"><span class="string">  virtual_router_id 51</span></span><br><span class="line"><span class="string">  priority 100</span></span><br><span class="line"><span class="string">  advert_int 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  virtual_ipaddress &#123;</span></span><br><span class="line"><span class="string">    192.168.56.250/24 dev enp0s8</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  authentication &#123;</span></span><br><span class="line"><span class="string">    auth_type PASS</span></span><br><span class="line"><span class="string">    auth_pass password</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  track_script &#123;</span></span><br><span class="line"><span class="string">    checkhaproxy</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/keepalived/check-haproxy.sh</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">count=\`netstat -apn | grep 9443 | wc -l\`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if [ $count -gt 0 ]; then</span></span><br><span class="line"><span class="string">  exit 0</span></span><br><span class="line"><span class="string">else </span></span><br><span class="line"><span class="string">  exit 1</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="基于docker部署Keepalived"><a href="#基于docker部署Keepalived" class="headerlink" title="基于docker部署Keepalived"></a>基于docker部署Keepalived</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105和192.168.56.106节点执行</span></span><br><span class="line">docker run -d --name k8s-keepalived \</span><br><span class="line">--restart=always \</span><br><span class="line">--net=host \</span><br><span class="line">--cap-add=NET_ADMIN --cap-add=NET_BROADCAST --cap-add=NET_RAW \</span><br><span class="line">-v /etc/keepalived/keepalived.conf:/container/service/keepalived/assets/keepalived.conf \</span><br><span class="line">-v /etc/keepalived/check-haproxy.sh:/usr/bin/check-haproxy.sh \</span><br><span class="line">osixia/keepalived:2.0.20 --copy-service</span><br></pre></td></tr></table></figure><h1 id="五、结果验证"><a href="#五、结果验证" class="headerlink" title="五、结果验证"></a>五、结果验证</h1><h2 id="查看vip状态"><a href="#查看vip状态" class="headerlink" title="查看vip状态"></a>查看vip状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105和192.168.56.106节点执行</span></span><br><span class="line">ip a</span><br></pre></td></tr></table></figure><p>结果截图<br>192.168.56.105中的<code>enp0s8</code>网卡获取到vip<br><img src="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/vip1.png"></p><p>192.168.56.106中的<code>enp0s8</code>网卡则没有获取到vip<br><img src="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/vip2.png"></p><h2 id="查看kube-apiserver高可用是否正常"><a href="#查看kube-apiserver高可用是否正常" class="headerlink" title="查看kube-apiserver高可用是否正常"></a>查看kube-apiserver高可用是否正常</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 任意节点执行</span></span><br><span class="line">curl -v -k https://192.168.56.250:9443</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/ha1.png"></p><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;零、目录&quot;&gt;&lt;a href=&quot;#零、目录&quot; class=&quot;headerlink&quot; title=&quot;零、目录&quot;&gt;&lt;/a&gt;零、目录&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%9</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="二进制" scheme="https://gaussli.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
    <category term="部署" scheme="https://gaussli.com/tags/%E9%83%A8%E7%BD%B2/"/>
    
    <category term="HAProxy" scheme="https://gaussli.com/tags/haproxy/"/>
    
    <category term="Keepalived" scheme="https://gaussli.com/tags/keepalived/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes二进制高可用部署4-Kube-Apiserver高可用部署</title>
    <link href="https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/"/>
    <id>https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/</id>
    <published>2022-01-15T18:00:02.000Z</published>
    <updated>2024-07-07T10:39:55.937Z</updated>
    
    <content type="html"><![CDATA[<h1 id="零、目录"><a href="#零、目录" class="headerlink" title="零、目录"></a>零、目录</h1><ul><li><a href="/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/" title="【容器化】Kubernetes二进制高可用部署1-准备">【容器化】Kubernetes二进制高可用部署1-准备</a></li><li><a href="/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/" title="【容器化】Kubernetes二进制高可用部署2-ca根证书">【容器化】Kubernetes二进制高可用部署2-ca根证书</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署3-etcd高可用部署">【容器化】kubernetes二进制高可用部署3-etcd高可用部署</a></li><li><strong><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署">【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署</a></strong></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署">【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B26-kube-controller%E5%92%8Ckube-scheduler%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署">【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署">【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署8-Calico网络插件部署">【容器化】kubernetes二进制高可用部署8-Calico网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B29-flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署">【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B210-coredns%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署10-coredns部署">【容器化】kubernetes二进制高可用部署10-coredns部署</a></li></ul><h1 id="一、说明"><a href="#一、说明" class="headerlink" title="一、说明"></a>一、说明</h1><p>本文将在三个虚拟机上都部署kube-apiserver服务，已达到一个三节点的kube-apiserver高可用集群。</p><h1 id="二、修改hosts文件"><a href="#二、修改hosts文件" class="headerlink" title="二、修改hosts文件"></a>二、修改hosts文件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt;&gt; /etc/hosts</span></span><br><span class="line"><span class="string">192.168.56.105 k8s1</span></span><br><span class="line"><span class="string">192.168.56.106 k8s2</span></span><br><span class="line"><span class="string">192.168.56.107 k8s3</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h1 id="三、kube-apiserver证书生成"><a href="#三、kube-apiserver证书生成" class="headerlink" title="三、kube-apiserver证书生成"></a>三、kube-apiserver证书生成</h1><h2 id="ssl配置文件"><a href="#ssl配置文件" class="headerlink" title="ssl配置文件"></a>ssl配置文件</h2><p>注意点：</p><ul><li><strong>alt_names的值指定为节点ip</strong></li><li>169.169.0.1：kubernetes 服务 IP 是 apiserver 自动创建的，一般是 –service-cluster-ip-range 参数指定的网段的第一个IP</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105节点执行</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/pki/master_ssl.cnf</span></span><br><span class="line"><span class="string">[ req ]</span></span><br><span class="line"><span class="string">req_extensions = v3_req</span></span><br><span class="line"><span class="string">distinguished_name = req_distinguished_name</span></span><br><span class="line"><span class="string">[ req_distinguished_name ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[ v3_req ]</span></span><br><span class="line"><span class="string">basicConstraints = CA:FALSE</span></span><br><span class="line"><span class="string">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[ alt_names ]</span></span><br><span class="line"><span class="string">DNS.1 = kubernetes</span></span><br><span class="line"><span class="string">DNS.2 = kubernetes.default</span></span><br><span class="line"><span class="string">DNS.3 = kubernetes.default.svc</span></span><br><span class="line"><span class="string">DNS.4 = kubernetes.default.svc.cluster.local</span></span><br><span class="line"><span class="string">DNS.5 = k8s1</span></span><br><span class="line"><span class="string">DNS.6 = k8s2</span></span><br><span class="line"><span class="string">DNS.7 = k8s3</span></span><br><span class="line"><span class="string">IP.1 = 169.169.0.1</span></span><br><span class="line"><span class="string">IP.2 = 192.168.56.105</span></span><br><span class="line"><span class="string">IP.3 = 192.168.56.106</span></span><br><span class="line"><span class="string">IP.4 = 192.168.56.107</span></span><br><span class="line"><span class="string">IP.5 = 192.168.56.250</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="服务端证书"><a href="#服务端证书" class="headerlink" title="服务端证书"></a>服务端证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105节点执行</span></span><br><span class="line">openssl genrsa -out /etc/kubernetes/pki/apiserver.key 2048</span><br><span class="line">openssl req -new -key /etc/kubernetes/pki/apiserver.key -config /etc/kubernetes/pki/master_ssl.cnf -subj <span class="string">&quot;/CN=192.168.56.105&quot;</span> -out /etc/kubernetes/pki/apiserver.csr</span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> /etc/kubernetes/pki/apiserver.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -days 36500 -extensions v3_req -extfile /etc/kubernetes/pki/master_ssl.cnf -out /etc/kubernetes/pki/apiserver.crt</span><br></pre></td></tr></table></figure><h2 id="复制kube-apiserver证书到106、107虚拟机"><a href="#复制kube-apiserver证书到106、107虚拟机" class="headerlink" title="复制kube-apiserver证书到106、107虚拟机"></a>复制kube-apiserver证书到106、107虚拟机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.106和192.168.56.107节点执行</span></span><br><span class="line">scp -r root@192.168.56.105:/etc/kubernetes/pki/apiserver.* /etc/kubernetes/pki/</span><br></pre></td></tr></table></figure><h1 id="四、下载kubernetes并解压并把二进制文件复制到-usr-bin目录"><a href="#四、下载kubernetes并解压并把二进制文件复制到-usr-bin目录" class="headerlink" title="四、下载kubernetes并解压并把二进制文件复制到&#x2F;usr&#x2F;bin目录"></a>四、下载kubernetes并解压并把二进制文件复制到&#x2F;usr&#x2F;bin目录</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点上执行</span></span><br><span class="line">wget -O /usr/local/src/kubernetes-server-v1.19.0.tar.gz https://dl.k8s.io/v1.19.0/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">tar -C /usr/local/src/ -zxvf /usr/local/src/kubernetes-server-v1.19.0.tar.gz</span><br><span class="line"><span class="built_in">cp</span> /usr/local/src/kubernetes/server/bin/kube-apiserver /usr/bin/</span><br></pre></td></tr></table></figure><h1 id="五、创建kube-apiserver服务"><a href="#五、创建kube-apiserver服务" class="headerlink" title="五、创建kube-apiserver服务"></a>五、创建kube-apiserver服务</h1><h2 id="创建kube-apiserver配置文件"><a href="#创建kube-apiserver配置文件" class="headerlink" title="创建kube-apiserver配置文件"></a>创建kube-apiserver配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105节点配置</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/apiserver.conf</span></span><br><span class="line"><span class="string">KUBE_API_ARGS=&quot;--insecure-port=0 \</span></span><br><span class="line"><span class="string">--secure-port=6443 \</span></span><br><span class="line"><span class="string">--advertise-address=192.168.56.105 \</span></span><br><span class="line"><span class="string">--tls-cert-file=/etc/kubernetes/pki/apiserver.crt \</span></span><br><span class="line"><span class="string">--tls-private-key-file=/etc/kubernetes/pki/apiserver.key \</span></span><br><span class="line"><span class="string">--client-ca-file=/etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="string">--apiserver-count=3 \</span></span><br><span class="line"><span class="string">--endpoint-reconciler-type=master-count \</span></span><br><span class="line"><span class="string">--etcd-servers=https://192.168.56.105:2379,https://192.168.56.106:2379,https://192.168.56.107:2379 \</span></span><br><span class="line"><span class="string">--etcd-cafile=/etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="string">--etcd-certfile=/etc/etcd/pki/etcd_client.crt \</span></span><br><span class="line"><span class="string">--etcd-keyfile=/etc/etcd/pki/etcd_client.key \</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=169.169.0.0/16 \</span></span><br><span class="line"><span class="string">--service-node-port-range=30000-32767 \</span></span><br><span class="line"><span class="string">--allow-privileged=true \</span></span><br><span class="line"><span class="string">--logtostderr=false --log-dir=/var/log/kubernetes --v=0&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.56.106节点配置</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/apiserver.conf</span></span><br><span class="line"><span class="string">KUBE_API_ARGS=&quot;--insecure-port=0 \</span></span><br><span class="line"><span class="string">--secure-port=6443 \</span></span><br><span class="line"><span class="string">--advertise-address=192.168.56.106 \</span></span><br><span class="line"><span class="string">--tls-cert-file=/etc/kubernetes/pki/apiserver.crt \</span></span><br><span class="line"><span class="string">--tls-private-key-file=/etc/kubernetes/pki/apiserver.key \</span></span><br><span class="line"><span class="string">--client-ca-file=/etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="string">--apiserver-count=3 \</span></span><br><span class="line"><span class="string">--endpoint-reconciler-type=master-count \</span></span><br><span class="line"><span class="string">--etcd-servers=https://192.168.56.105:2379,https://192.168.56.106:2379,https://192.168.56.107:2379 \</span></span><br><span class="line"><span class="string">--etcd-cafile=/etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="string">--etcd-certfile=/etc/etcd/pki/etcd_client.crt \</span></span><br><span class="line"><span class="string">--etcd-keyfile=/etc/etcd/pki/etcd_client.key \</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=169.169.0.0/16 \</span></span><br><span class="line"><span class="string">--service-node-port-range=30000-32767 \</span></span><br><span class="line"><span class="string">--allow-privileged=true \</span></span><br><span class="line"><span class="string">--logtostderr=false --log-dir=/var/log/kubernetes --v=0&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.56.107节点配置</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/kubernetes/apiserver.conf</span></span><br><span class="line"><span class="string">KUBE_API_ARGS=&quot;--insecure-port=0 \</span></span><br><span class="line"><span class="string">--secure-port=6443 \</span></span><br><span class="line"><span class="string">--advertise-address=192.168.56.107 \</span></span><br><span class="line"><span class="string">--tls-cert-file=/etc/kubernetes/pki/apiserver.crt \</span></span><br><span class="line"><span class="string">--tls-private-key-file=/etc/kubernetes/pki/apiserver.key \</span></span><br><span class="line"><span class="string">--client-ca-file=/etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="string">--apiserver-count=3 \</span></span><br><span class="line"><span class="string">--endpoint-reconciler-type=master-count \</span></span><br><span class="line"><span class="string">--etcd-servers=https://192.168.56.105:2379,https://192.168.56.106:2379,https://192.168.56.107:2379 \</span></span><br><span class="line"><span class="string">--etcd-cafile=/etc/kubernetes/pki/ca.crt \</span></span><br><span class="line"><span class="string">--etcd-certfile=/etc/etcd/pki/etcd_client.crt \</span></span><br><span class="line"><span class="string">--etcd-keyfile=/etc/etcd/pki/etcd_client.key \</span></span><br><span class="line"><span class="string">--service-cluster-ip-range=169.169.0.0/16 \</span></span><br><span class="line"><span class="string">--service-node-port-range=30000-32767 \</span></span><br><span class="line"><span class="string">--allow-privileged=true \</span></span><br><span class="line"><span class="string">--logtostderr=false --log-dir=/var/log/kubernetes --v=0&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="创建系统服务文件"><a href="#创建系统服务文件" class="headerlink" title="创建系统服务文件"></a>创建系统服务文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /usr/lib/systemd/system/kube-apiserver.service</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes API Server</span></span><br><span class="line"><span class="string">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">EnvironmentFile=/etc/kubernetes/apiserver.conf</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/kube-apiserver \$KUBE_API_ARGS</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="启动kube-apiserver服务"><a href="#启动kube-apiserver服务" class="headerlink" title="启动kube-apiserver服务"></a>启动kube-apiserver服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start kube-apiserver</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-apiserver</span><br></pre></td></tr></table></figure><h1 id="六、kube-apiserver服务验证"><a href="#六、kube-apiserver服务验证" class="headerlink" title="六、kube-apiserver服务验证"></a>六、kube-apiserver服务验证</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看服务运行状态</span></span><br><span class="line">systemctl status kube-apiserver</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问kube-apiserver是否有内容成功返回</span></span><br><span class="line">curl -v -k https://192.168.56.105:6443</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/apiserver1.png"><br><img src="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/apiserver2.png"></p><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;零、目录&quot;&gt;&lt;a href=&quot;#零、目录&quot; class=&quot;headerlink&quot; title=&quot;零、目录&quot;&gt;&lt;/a&gt;零、目录&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%9</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="二进制" scheme="https://gaussli.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
    <category term="部署" scheme="https://gaussli.com/tags/%E9%83%A8%E7%BD%B2/"/>
    
    <category term="kube-apiserver" scheme="https://gaussli.com/tags/kube-apiserver/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes二进制高可用部署3-Etcd高可用部署</title>
    <link href="https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/"/>
    <id>https://gaussli.com/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/</id>
    <published>2022-01-15T16:48:25.000Z</published>
    <updated>2024-07-07T10:39:46.103Z</updated>
    
    <content type="html"><![CDATA[<h1 id="零、目录"><a href="#零、目录" class="headerlink" title="零、目录"></a>零、目录</h1><ul><li><a href="/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/" title="【容器化】Kubernetes二进制高可用部署1-准备">【容器化】Kubernetes二进制高可用部署1-准备</a></li><li><a href="/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/" title="【容器化】Kubernetes二进制高可用部署2-ca根证书">【容器化】Kubernetes二进制高可用部署2-ca根证书</a></li><li><strong><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署3-etcd高可用部署">【容器化】kubernetes二进制高可用部署3-etcd高可用部署</a></strong></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署">【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署">【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B26-kube-controller%E5%92%8Ckube-scheduler%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署">【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署">【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署8-Calico网络插件部署">【容器化】kubernetes二进制高可用部署8-Calico网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B29-flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署">【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B210-coredns%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署10-coredns部署">【容器化】kubernetes二进制高可用部署10-coredns部署</a></li></ul><h1 id="一、说明"><a href="#一、说明" class="headerlink" title="一、说明"></a>一、说明</h1><p>本文将在三个虚拟机上都部署etcd服务，已达到一个三节点的etcd高可用集群。</p><h1 id="二、etcd证书生成"><a href="#二、etcd证书生成" class="headerlink" title="二、etcd证书生成"></a>二、etcd证书生成</h1><h2 id="ssl配置文件"><a href="#ssl配置文件" class="headerlink" title="ssl配置文件"></a>ssl配置文件</h2><p>注意点：<strong>alt_names的值指定为节点ip</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105节点执行</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/etcd/pki</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/etcd/pki/etcd_ssl.cnf</span></span><br><span class="line"><span class="string">[ req ]</span></span><br><span class="line"><span class="string">req_extensions = v3_req</span></span><br><span class="line"><span class="string">distinguished_name = req_distinguished_name</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[ req_distinguished_name ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[ v3_req ]</span></span><br><span class="line"><span class="string">basicConstraints = CA:FALSE</span></span><br><span class="line"><span class="string">keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[ alt_names ]</span></span><br><span class="line"><span class="string">IP.1 = 192.168.56.105</span></span><br><span class="line"><span class="string">IP.2 = 192.168.56.106</span></span><br><span class="line"><span class="string">IP.3 = 192.168.56.107</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="服务端证书"><a href="#服务端证书" class="headerlink" title="服务端证书"></a>服务端证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105节点执行</span></span><br><span class="line">openssl genrsa -out /etc/etcd/pki/etcd_server.key 2048</span><br><span class="line">openssl req -new -key /etc/etcd/pki/etcd_server.key -config /etc/etcd/pki/etcd_ssl.cnf -subj <span class="string">&quot;/CN=etcd-server&quot;</span> -out /etc/etcd/pki/etcd_server.csr</span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> /etc/etcd/pki/etcd_server.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -days 36500 -extensions v3_req -extfile /etc/etcd/pki/etcd_ssl.cnf -out /etc/etcd/pki/etcd_server.crt</span><br></pre></td></tr></table></figure><h2 id="客户端证书"><a href="#客户端证书" class="headerlink" title="客户端证书"></a>客户端证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105节点执行</span></span><br><span class="line">openssl genrsa -out /etc/etcd/pki/etcd_client.key 2048</span><br><span class="line">openssl req -new -key /etc/etcd/pki/etcd_client.key -config /etc/etcd/pki/etcd_ssl.cnf -subj <span class="string">&quot;/CN=etcd-client&quot;</span> -out /etc/etcd/pki/etcd_client.csr</span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> /etc/etcd/pki/etcd_client.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -days 36500 -extensions v3_req -extfile /etc/etcd/pki/etcd_ssl.cnf -out /etc/etcd/pki/etcd_client.crt</span><br></pre></td></tr></table></figure><h2 id="复制etcd证书到106、107虚拟机"><a href="#复制etcd证书到106、107虚拟机" class="headerlink" title="复制etcd证书到106、107虚拟机"></a>复制etcd证书到106、107虚拟机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.106和192.168.56.107节点执行</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/etcd/pki</span><br><span class="line">scp -r root@192.168.56.105:/etc/etcd/pki/ /etc/etcd</span><br></pre></td></tr></table></figure><h1 id="三、下载etcd并解压并把二进制文件复制到-usr-bin目录"><a href="#三、下载etcd并解压并把二进制文件复制到-usr-bin目录" class="headerlink" title="三、下载etcd并解压并把二进制文件复制到&#x2F;usr&#x2F;bin目录"></a>三、下载etcd并解压并把二进制文件复制到&#x2F;usr&#x2F;bin目录</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line">wget -O /usr/local/src/etcd-v3.4.13-linux-amd64.tar.gz https://github.com/etcd-io/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">tar -C /usr/local/src/ -zxvf /usr/local/src/etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cp</span> /usr/local/src/etcd-v3.4.13-linux-amd64/etcd /usr/local/src/etcd-v3.4.13-linux-amd64/etcdctl /usr/bin/</span><br></pre></td></tr></table></figure><h1 id="四、创建etcd服务"><a href="#四、创建etcd服务" class="headerlink" title="四、创建etcd服务"></a>四、创建etcd服务</h1><h2 id="创建etcd配置文件"><a href="#创建etcd配置文件" class="headerlink" title="创建etcd配置文件"></a>创建etcd配置文件</h2><p>etcd服务参数说明：</p><ul><li>ETCD_NAME：etcd节点名称，每个节点都应不同，例如：etcd1、etcd2、etcd3</li><li>ETCD_DATA_DIR：etcd数据存储目录，例如：&#x2F;etc&#x2F;etcd&#x2F;data</li><li>ETCD_LISTEN_CLIENT_URLS和ETCD_ADVERTISE_CLIENT_URLS：为客户端提供的服务监听URL地址，例如：<a href="https://192.168.56.105:2379/">https://192.168.56.105:2379</a></li><li>ETCD_LISTEN_PEER_URLS和ETCD_INITIAL_ADVERTISE_PEER_URLS：为本etcd集群其他节点提供的服务监听URL地址，例如：<a href="https://192.168.56.105:2380/">https://192.168.56.105:2380</a></li><li>ETCD_INITIAL_CLUSTER_TOKEN：etcd集群名称，例如：etcd-cluster</li><li>ETCD_INITIAL_CLUSTER：etcd集群各节点的endpoint列表</li><li>ETCD_INITIAL_CLUSTER_STATE：初始集群状态，新建集群时设置为“new”，集群已存在时设置为“existing”</li></ul><p>ca证书参数说明：</p><ul><li>ETCD_CERT_FILE：etcd服务端CA证书<code>crt文件</code>全路径</li><li>ETCD_KEY_FILE：etcd服务端CA证书<code>key文件</code>全路径</li><li>ETCD_TRUSTED_CA_FILE：CA根证书文件全路径</li><li>ETCD_CLIENT_CERT_AUTH：是否启用客户端证书认证</li><li>ETCD_PEER_CERT_FILE：etcd集群各节点相互认证使用的CA证书<code>crt文件</code>全路径</li><li>ETCD_PEER_KEY_FILE：etcd集群各节点相互认证使用的CA证书<code>key文件</code>全路径</li><li>ETCD_PEER_TRUSTED_CA_FILE：etcd集群各节点相互认证使用的CA根证书文件全路径</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105节点配置</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="string">ETCD_NAME=etcd1</span></span><br><span class="line"><span class="string">ETCD_DATA_DIR=/etc/etcd/data</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ETCD_CERT_FILE=/etc/etcd/pki/etcd_server.crt</span></span><br><span class="line"><span class="string">ETCD_KEY_FILE=/etc/etcd/pki/etcd_server.key</span></span><br><span class="line"><span class="string">ETCD_TRUSTED_CA_FILE=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="string">ETCD_CLIENT_CERT_AUTH=true</span></span><br><span class="line"><span class="string">ETCD_LISTEN_CLIENT_URLS=https://192.168.56.105:2379</span></span><br><span class="line"><span class="string">ETCD_ADVERTISE_CLIENT_URLS=https://192.168.56.105:2379</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ETCD_PEER_CERT_FILE=/etc/etcd/pki/etcd_server.crt</span></span><br><span class="line"><span class="string">ETCD_PEER_KEY_FILE=/etc/etcd/pki/etcd_server.key</span></span><br><span class="line"><span class="string">ETCD_PEER_TRUSTED_CA_FILE=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="string">ETCD_LISTEN_PEER_URLS=https://192.168.56.105:2380</span></span><br><span class="line"><span class="string">ETCD_INITIAL_ADVERTISE_PEER_URLS=https://192.168.56.105:2380</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster</span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER=&quot;etcd1=https://192.168.56.105:2380,etcd2=https://192.168.56.106:2380,etcd3=https://192.168.56.107:2380&quot;</span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER_STATE=new</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.56.106节点配置</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="string">ETCD_NAME=etcd2</span></span><br><span class="line"><span class="string">ETCD_DATA_DIR=/etc/etcd/data</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ETCD_CERT_FILE=/etc/etcd/pki/etcd_server.crt</span></span><br><span class="line"><span class="string">ETCD_KEY_FILE=/etc/etcd/pki/etcd_server.key</span></span><br><span class="line"><span class="string">ETCD_TRUSTED_CA_FILE=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="string">ETCD_CLIENT_CERT_AUTH=true</span></span><br><span class="line"><span class="string">ETCD_LISTEN_CLIENT_URLS=https://192.168.56.106:2379</span></span><br><span class="line"><span class="string">ETCD_ADVERTISE_CLIENT_URLS=https://192.168.56.106:2379</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ETCD_PEER_CERT_FILE=/etc/etcd/pki/etcd_server.crt</span></span><br><span class="line"><span class="string">ETCD_PEER_KEY_FILE=/etc/etcd/pki/etcd_server.key</span></span><br><span class="line"><span class="string">ETCD_PEER_TRUSTED_CA_FILE=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="string">ETCD_LISTEN_PEER_URLS=https://192.168.56.106:2380</span></span><br><span class="line"><span class="string">ETCD_INITIAL_ADVERTISE_PEER_URLS=https://192.168.56.106:2380</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster</span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER=&quot;etcd1=https://192.168.56.105:2380,etcd2=https://192.168.56.106:2380,etcd3=https://192.168.56.107:2380&quot;</span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER_STATE=new</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 192.168.56.107节点配置</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /etc/etcd/etcd.conf</span></span><br><span class="line"><span class="string">ETCD_NAME=etcd3</span></span><br><span class="line"><span class="string">ETCD_DATA_DIR=/etc/etcd/data</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ETCD_CERT_FILE=/etc/etcd/pki/etcd_server.crt</span></span><br><span class="line"><span class="string">ETCD_KEY_FILE=/etc/etcd/pki/etcd_server.key</span></span><br><span class="line"><span class="string">ETCD_TRUSTED_CA_FILE=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="string">ETCD_CLIENT_CERT_AUTH=true</span></span><br><span class="line"><span class="string">ETCD_LISTEN_CLIENT_URLS=https://192.168.56.107:2379</span></span><br><span class="line"><span class="string">ETCD_ADVERTISE_CLIENT_URLS=https://192.168.56.107:2379</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ETCD_PEER_CERT_FILE=/etc/etcd/pki/etcd_server.crt</span></span><br><span class="line"><span class="string">ETCD_PEER_KEY_FILE=/etc/etcd/pki/etcd_server.key</span></span><br><span class="line"><span class="string">ETCD_PEER_TRUSTED_CA_FILE=/etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="string">ETCD_LISTEN_PEER_URLS=https://192.168.56.107:2380</span></span><br><span class="line"><span class="string">ETCD_INITIAL_ADVERTISE_PEER_URLS=https://192.168.56.107:2380</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster</span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER=&quot;etcd1=https://192.168.56.105:2380,etcd2=https://192.168.56.106:2380,etcd3=https://192.168.56.107:2380&quot;</span></span><br><span class="line"><span class="string">ETCD_INITIAL_CLUSTER_STATE=new</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="创建系统服务文件"><a href="#创建系统服务文件" class="headerlink" title="创建系统服务文件"></a>创建系统服务文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; /usr/lib/systemd/system/etcd.service</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=etcd key-value store</span></span><br><span class="line"><span class="string">Documentation=https://github.com/etcd-io/etcd</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">EnvironmentFile=/etc/etcd/etcd.conf</span></span><br><span class="line"><span class="string">ExecStart=/usr/bin/etcd</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="启动etcd服务"><a href="#启动etcd服务" class="headerlink" title="启动etcd服务"></a>启动etcd服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有节点执行</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br></pre></td></tr></table></figure><h1 id="五、etcd服务验证"><a href="#五、etcd服务验证" class="headerlink" title="五、etcd服务验证"></a>五、etcd服务验证</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 任意节点执行</span></span><br><span class="line">etcdctl --cacert=/etc/kubernetes/pki/ca.crt \</span><br><span class="line">--cert=/etc/etcd/pki/etcd_client.crt \</span><br><span class="line">--key=/etc/etcd/pki/etcd_client.key \</span><br><span class="line">--endpoints=https://192.168.56.105:2379,https://192.168.56.106:2379,https://192.168.56.107:2379 \</span><br><span class="line">endpoint health</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/etcd1.png"></p><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;零、目录&quot;&gt;&lt;a href=&quot;#零、目录&quot; class=&quot;headerlink&quot; title=&quot;零、目录&quot;&gt;&lt;/a&gt;零、目录&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%9</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="二进制" scheme="https://gaussli.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
    <category term="部署" scheme="https://gaussli.com/tags/%E9%83%A8%E7%BD%B2/"/>
    
    <category term="高可用" scheme="https://gaussli.com/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
    <category term="etcd" scheme="https://gaussli.com/tags/etcd/"/>
    
    <category term="数据库" scheme="https://gaussli.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes二进制高可用部署2-Ca根证书</title>
    <link href="https://gaussli.com/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/"/>
    <id>https://gaussli.com/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/</id>
    <published>2022-01-15T13:55:23.000Z</published>
    <updated>2024-07-07T10:39:50.977Z</updated>
    
    <content type="html"><![CDATA[<h1 id="零、目录"><a href="#零、目录" class="headerlink" title="零、目录"></a>零、目录</h1><ul><li><a href="/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/" title="【容器化】Kubernetes二进制高可用部署1-准备">【容器化】Kubernetes二进制高可用部署1-准备</a></li><li><strong><a href="/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/" title="【容器化】Kubernetes二进制高可用部署2-ca根证书">【容器化】Kubernetes二进制高可用部署2-ca根证书</a></strong></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署3-etcd高可用部署">【容器化】kubernetes二进制高可用部署3-etcd高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署">【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署">【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B26-kube-controller%E5%92%8Ckube-scheduler%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署">【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署">【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署8-Calico网络插件部署">【容器化】kubernetes二进制高可用部署8-Calico网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B29-flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署">【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B210-coredns%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署10-coredns部署">【容器化】kubernetes二进制高可用部署10-coredns部署</a></li></ul><h1 id="一、证书"><a href="#一、证书" class="headerlink" title="一、证书"></a>一、证书</h1><h2 id="x509"><a href="#x509" class="headerlink" title="x509"></a>x509</h2><blockquote><p>X.509是密码学里公钥证书的格式标准。X.509证书已应用在包括TLS&#x2F;SSL在内的众多网络协议里，同时它也用在很多非在线应用场景里，比如电子签名服务。X.509证书里含有公钥、身份信息（比如网络主机名，组织的名称或个体名称等）和签名信息（可以是证书签发机构CA的签名，也可以是自签名）。</p></blockquote><p>说白了，就是一个常用的数字证书标准。一个标准的X.509数字证书包含以下内容：</p><ul><li>证书<ul><li>版本号</li><li>序列号</li><li>签名算法</li><li>证书有效期<ul><li>此日期前无效</li><li>此日期后无效</li></ul></li><li>主题</li><li>主题公钥信息<ul><li>公钥算法</li><li>主题公钥</li></ul></li><li>颁发着唯一身份信息（可选项）</li><li>主题唯一身份信息（可选项）</li><li>扩展信息（可选项）<ul><li>……</li></ul></li></ul></li><li>证书签名算法</li><li>数字签名</li></ul><h2 id="证书格式"><a href="#证书格式" class="headerlink" title="证书格式"></a>证书格式</h2><ul><li>.key：一般是base64编码的公钥或私钥文件</li><li>.der .cer .crt：DER二进制编码格式的证书</li><li>.pem .cer .crt：DER二进制编码格式进行base64编码的证书</li><li>.p12：包含证书和私钥的文件</li></ul><h2 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .key文件生成（pem）</span></span><br><span class="line">openssl genrsa -out xxx.key 2048</span><br><span class="line"><span class="comment"># .key文件查看（pem）</span></span><br><span class="line">openssl rsa -noout -text -<span class="keyword">in</span> xxx.key</span><br><span class="line"><span class="comment"># .key从pem转到der（der）</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> xxx.key -outform der -out xxx-der.key</span><br><span class="line"><span class="comment"># .key文件查看（der）</span></span><br><span class="line">openssl rsa -noout -text -inform der -<span class="keyword">in</span> xxx-der.key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># .pem证书文件生成</span></span><br><span class="line">openssl req -x509 -new -key xxx.key -out xxx.pem</span><br><span class="line"><span class="comment"># .pem证书文件查看</span></span><br><span class="line">openssl x509 -noout -text -<span class="keyword">in</span> xxx.pem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># .der证书文件生成</span></span><br><span class="line">openssl req -x509 -new -outform der -key xxx.key -out xxx.der</span><br><span class="line"><span class="comment"># .der证书文件查看</span></span><br><span class="line">openssl x509 -noout -text -inform der -<span class="keyword">in</span> xxx.der</span><br></pre></td></tr></table></figure><h1 id="二、Kubernetes的CA证书"><a href="#二、Kubernetes的CA证书" class="headerlink" title="二、Kubernetes的CA证书"></a>二、Kubernetes的CA证书</h1><h2 id="生成Kubernets需要用到的CA证书"><a href="#生成Kubernets需要用到的CA证书" class="headerlink" title="生成Kubernets需要用到的CA证书"></a>生成Kubernets需要用到的CA证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.105节点执行</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/kubernetes/pki</span><br><span class="line">openssl genrsa -out /etc/kubernetes/pki/ca.key 2048</span><br><span class="line">openssl req -x509 -new -key /etc/kubernetes/pki/ca.key -days 36500 -subj <span class="string">&quot;/CN=192.168.56.105&quot;</span> -out /etc/kubernetes/pki/ca.crt</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/ca1.png"></p><h2 id="复制ca-key和ca-crt到106、107虚拟机"><a href="#复制ca-key和ca-crt到106、107虚拟机" class="headerlink" title="复制ca.key和ca.crt到106、107虚拟机"></a>复制ca.key和ca.crt到106、107虚拟机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 192.168.56.106和192.168.56.107节点执行</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/kubernetes/pki</span><br><span class="line">scp -r root@192.168.56.105:/etc/kubernetes/pki/ /etc/kubernetes</span><br></pre></td></tr></table></figure><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;零、目录&quot;&gt;&lt;a href=&quot;#零、目录&quot; class=&quot;headerlink&quot; title=&quot;零、目录&quot;&gt;&lt;/a&gt;零、目录&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%9</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="二进制" scheme="https://gaussli.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
    <category term="部署" scheme="https://gaussli.com/tags/%E9%83%A8%E7%BD%B2/"/>
    
    <category term="高可用" scheme="https://gaussli.com/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
    <category term="ca证书" scheme="https://gaussli.com/tags/ca%E8%AF%81%E4%B9%A6/"/>
    
    <category term="openssl" scheme="https://gaussli.com/tags/openssl/"/>
    
    <category term="x509" scheme="https://gaussli.com/tags/x509/"/>
    
    <category term="pem" scheme="https://gaussli.com/tags/pem/"/>
    
    <category term="der" scheme="https://gaussli.com/tags/der/"/>
    
    <category term="crt" scheme="https://gaussli.com/tags/crt/"/>
    
    <category term="cer" scheme="https://gaussli.com/tags/cer/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes二进制高可用部署1-准备</title>
    <link href="https://gaussli.com/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/"/>
    <id>https://gaussli.com/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/</id>
    <published>2021-09-12T09:14:59.000Z</published>
    <updated>2024-12-01T08:46:02.814Z</updated>
    
    <content type="html"><![CDATA[<h1 id="零、目录"><a href="#零、目录" class="headerlink" title="零、目录"></a>零、目录</h1><ul><li><strong><a href="/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/" title="【容器化】Kubernetes二进制高可用部署1-准备">【容器化】Kubernetes二进制高可用部署1-准备</a></strong></li><li><a href="/2022/01/15/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B22-ca%E6%A0%B9%E8%AF%81%E4%B9%A6/" title="【容器化】Kubernetes二进制高可用部署2-ca根证书">【容器化】Kubernetes二进制高可用部署2-ca根证书</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B23-etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署3-etcd高可用部署">【容器化】kubernetes二进制高可用部署3-etcd高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B24-kube-apiserver%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署">【容器化】kubernetes二进制高可用部署4-kube-apiserver高可用部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B25-ha%E5%92%8Ckeepalived%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署">【容器化】kubernetes二进制高可用部署5-HA和Keepalived部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B26-kube-controller%E5%92%8Ckube-scheduler%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署">【容器化】kubernetes二进制高可用部署6-kube-controller和kube-scheduler部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B27-kubelet%E5%92%8Ckube-proxy%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署">【容器化】kubernetes二进制高可用部署7-kubelet和kube-proxy部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B28-calico%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署8-Calico网络插件部署">【容器化】kubernetes二进制高可用部署8-Calico网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B29-flannel%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署">【容器化】kubernetes二进制高可用部署9-Flannel网络插件部署</a></li><li><a href="/2022/01/16/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B210-coredns%E9%83%A8%E7%BD%B2/" title="【容器化】kubernetes二进制高可用部署10-coredns部署">【容器化】kubernetes二进制高可用部署10-coredns部署</a></li></ul><h1 id="一、虚拟机信息"><a href="#一、虚拟机信息" class="headerlink" title="一、虚拟机信息"></a>一、虚拟机信息</h1><h2 id="虚拟机配置"><a href="#虚拟机配置" class="headerlink" title="虚拟机配置"></a>虚拟机配置</h2><ul><li>SYSTEM OS：CentOS7.9.2009</li><li>KERNEL：3.10.0-1160</li><li>CPU：2C</li><li>MEMORY：2G</li><li>DISK：8G<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看内核版本</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="built_in">cat</span> /proc/version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看CentOS版本</span></span><br><span class="line"><span class="built_in">cat</span> /etc/centos-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看cpu核数</span></span><br><span class="line"><span class="built_in">cat</span> /proc/cpuinfo | grep processor |<span class="built_in">wc</span> -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内存</span></span><br><span class="line">free -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看磁盘大小</span></span><br><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure>结果截图<br><img src="/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B21-%E5%87%86%E5%A4%87/pre1.png"></li></ul><h2 id="IP信息"><a href="#IP信息" class="headerlink" title="IP信息"></a>IP信息</h2><table><thead><tr><th>主机名</th><th>IP</th></tr></thead><tbody><tr><td>centos1</td><td>192.168.56.105</td></tr><tr><td>centos2</td><td>192.168.56.106</td></tr><tr><td>centos3</td><td>192.168.56.107</td></tr></tbody></table><h2 id="Master高可用节点的VIP"><a href="#Master高可用节点的VIP" class="headerlink" title="Master高可用节点的VIP"></a>Master高可用节点的VIP</h2><p>需要保证该IP没有被网络内其他主机使用</p><ul><li>192.168.56.250</li></ul><h1 id="二、Kubernetes相关信息"><a href="#二、Kubernetes相关信息" class="headerlink" title="二、Kubernetes相关信息"></a>二、Kubernetes相关信息</h1><h2 id="Kubernetes中ClusterIp的cidr"><a href="#Kubernetes中ClusterIp的cidr" class="headerlink" title="Kubernetes中ClusterIp的cidr"></a>Kubernetes中ClusterIp的cidr</h2><p>需要保证该网段不和主机网络重复</p><ul><li>169.169.0.0&#x2F;16</li></ul><h2 id="服务部署版本"><a href="#服务部署版本" class="headerlink" title="服务部署版本"></a>服务部署版本</h2><table><thead><tr><th>服务名</th><th>版本</th></tr></thead><tbody><tr><td>docker</td><td>19.03.15</td></tr><tr><td>etcd</td><td>v3.4.13</td></tr><tr><td>kubernetes</td><td>v1.19.0</td></tr></tbody></table><h1 id="三、前期准备"><a href="#三、前期准备" class="headerlink" title="三、前期准备"></a>三、前期准备</h1><h2 id="所有主机禁用swap虚拟内存"><a href="#所有主机禁用swap虚拟内存" class="headerlink" title="所有主机禁用swap虚拟内存"></a>所有主机禁用swap虚拟内存</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看默认是否开启swap虚拟内存，swap端不为0则说明开启</span></span><br><span class="line">free -h</span><br><span class="line"><span class="comment"># 临时禁用swap</span></span><br><span class="line">swapoff -a</span><br><span class="line"><span class="comment"># 永久禁用swap，需重启服务生效</span></span><br><span class="line">sed -i <span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab</span><br><span class="line"><span class="comment"># 再次查看swap是否已关闭</span></span><br><span class="line">free -h</span><br></pre></td></tr></table></figure><h2 id="所有主机禁用SELinux"><a href="#所有主机禁用SELinux" class="headerlink" title="所有主机禁用SELinux"></a>所有主机禁用SELinux</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看默认是否已关闭</span></span><br><span class="line">getenforce</span><br><span class="line"><span class="comment"># 临时禁用</span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="comment"># 永久禁用，需重启服务器生效</span></span><br><span class="line">sed -i <span class="string">&quot;s/^SELINUX=.*/SELINUX=disabled/g&quot;</span> /etc/selinux/config</span><br><span class="line"><span class="comment"># 再次查看是否已关闭</span></span><br><span class="line">getenforce</span><br></pre></td></tr></table></figure><h2 id="所有主机关闭防火墙"><a href="#所有主机关闭防火墙" class="headerlink" title="所有主机关闭防火墙"></a>所有主机关闭防火墙</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有主机执行</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><h2 id="创建kubernetes日志目录"><a href="#创建kubernetes日志目录" class="headerlink" title="创建kubernetes日志目录"></a>创建kubernetes日志目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有主机执行</span></span><br><span class="line"><span class="built_in">mkdir</span> /var/log/kubernetes</span><br></pre></td></tr></table></figure><h2 id="安装必要的工具"><a href="#安装必要的工具" class="headerlink" title="安装必要的工具"></a>安装必要的工具</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 安装net-tools工具</span><br><span class="line">yum install -y net-tools</span><br></pre></td></tr></table></figure><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;零、目录&quot;&gt;&lt;a href=&quot;#零、目录&quot; class=&quot;headerlink&quot; title=&quot;零、目录&quot;&gt;&lt;/a&gt;零、目录&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;/2021/09/12/%E3%80%90%E5%AE%B9%E5%99%A8</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="二进制" scheme="https://gaussli.com/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/"/>
    
    <category term="部署" scheme="https://gaussli.com/tags/%E9%83%A8%E7%BD%B2/"/>
    
    <category term="高可用" scheme="https://gaussli.com/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
    <category term="内核" scheme="https://gaussli.com/tags/%E5%86%85%E6%A0%B8/"/>
    
    <category term="cpu" scheme="https://gaussli.com/tags/cpu/"/>
    
    <category term="虚拟内存" scheme="https://gaussli.com/tags/%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98/"/>
    
    <category term="SELinux" scheme="https://gaussli.com/tags/selinux/"/>
    
    <category term="firewall" scheme="https://gaussli.com/tags/firewall/"/>
    
  </entry>
  
  <entry>
    <title>【Linux】修改时间为上海时间</title>
    <link href="https://gaussli.com/2021/09/11/%E3%80%90linux%E3%80%91%E4%BF%AE%E6%94%B9%E6%97%B6%E9%97%B4%E4%B8%BA%E4%B8%8A%E6%B5%B7%E6%97%B6%E9%97%B4/"/>
    <id>https://gaussli.com/2021/09/11/%E3%80%90linux%E3%80%91%E4%BF%AE%E6%94%B9%E6%97%B6%E9%97%B4%E4%B8%BA%E4%B8%8A%E6%B5%B7%E6%97%B6%E9%97%B4/</id>
    <published>2021-09-11T07:49:27.000Z</published>
    <updated>2021-09-12T09:15:50.776Z</updated>
    
    <content type="html"><![CDATA[<p>CentOS7纯默认安装的时间会是美国东部时间（EDT）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2021年 09月 11日 星期六 03:42:28 EDT</span></span><br><span class="line"><span class="built_in">date</span></span><br></pre></td></tr></table></figure><p>修改为上海时间（CST）（中国标准时间）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> /etc/localtime /etc/localtime.bak</span><br><span class="line"><span class="built_in">ln</span> -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br></pre></td></tr></table></figure><p>再次查看时间</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2021年 09月 11日 星期六 15:44:50 CST</span></span><br><span class="line"><span class="built_in">date</span></span><br></pre></td></tr></table></figure><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;CentOS7纯默认安装的时间会是美国东部时间（EDT）&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span c</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Linux" scheme="https://gaussli.com/categories/tech/linux/"/>
    
    
    <category term="时间" scheme="https://gaussli.com/tags/%E6%97%B6%E9%97%B4/"/>
    
    <category term="linux" scheme="https://gaussli.com/tags/linux/"/>
    
    <category term="localtime" scheme="https://gaussli.com/tags/localtime/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】K3S部署安装</title>
    <link href="https://gaussli.com/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91k3s%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/"/>
    <id>https://gaussli.com/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91k3s%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/</id>
    <published>2021-07-26T15:06:14.000Z</published>
    <updated>2021-07-26T15:10:04.581Z</updated>
    
    <content type="html"><![CDATA[<h1 id="本文针对版本v1-21-2-k3s1"><a href="#本文针对版本v1-21-2-k3s1" class="headerlink" title="本文针对版本v1.21.2+k3s1"></a>本文针对版本v1.21.2+k3s1</h1><h1 id="官网"><a href="#官网" class="headerlink" title="官网"></a>官网</h1><p><a href="https://k3s.io/">https://k3s.io/</a></p><h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 关闭防火墙</span><br><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure><h1 id="完成可联网情况下"><a href="#完成可联网情况下" class="headerlink" title="完成可联网情况下"></a>完成可联网情况下</h1><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="variable constant_">INSTALL_K3S_VERSION</span>=v1<span class="number">.21</span><span class="number">.2</span>+k3s1</span><br><span class="line"><span class="keyword">export</span> <span class="variable constant_">INSTALL_K3S_EXEC</span>=<span class="string">&quot;--write-kubeconfig ~/.kube/config --cluster-cidr  10.72.0.0/16 --service-cidr  10.73.0.0/16&quot;</span></span><br><span class="line">curl -sfL <span class="attr">https</span>:<span class="comment">//get.k3s.io | sh -</span></span><br></pre></td></tr></table></figure><h1 id="连不上Github情况下"><a href="#连不上Github情况下" class="headerlink" title="连不上Github情况下"></a>连不上Github情况下</h1><h2 id="1-上传相关工具、k3s二进制包、k3s安装脚本、Nginx测试yaml文件到服务器"><a href="#1-上传相关工具、k3s二进制包、k3s安装脚本、Nginx测试yaml文件到服务器" class="headerlink" title="1. 上传相关工具、k3s二进制包、k3s安装脚本、Nginx测试yaml文件到服务器"></a>1. 上传相关工具、k3s二进制包、k3s安装脚本、Nginx测试yaml文件到服务器</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scp k3s-selinux-<span class="number">0.2</span>-<span class="number">1.</span>el7_8.<span class="property">noarch</span>.<span class="property">rpm</span> root@xxx.<span class="property">xxx</span>.<span class="property">xxx</span>.<span class="property">xxx</span>:<span class="regexp">/usr/</span>local/src/</span><br><span class="line">scp k3s root@xxx.<span class="property">xxx</span>.<span class="property">xxx</span>.<span class="property">xxx</span>:<span class="regexp">/usr/</span>local/src/</span><br><span class="line">scp k3s.<span class="property">sh</span> root@xxx.<span class="property">xxx</span>.<span class="property">xxx</span>.<span class="property">xxx</span>:<span class="regexp">/usr/</span>local/src/</span><br><span class="line">scp nginx.<span class="property">yaml</span> root@xxx.<span class="property">xxx</span>.<span class="property">xxx</span>.<span class="property">xxx</span>:<span class="regexp">/usr/</span>local/src/</span><br></pre></td></tr></table></figure><h2 id="2-配置k3s二进制包的路径和权限"><a href="#2-配置k3s二进制包的路径和权限" class="headerlink" title="2. 配置k3s二进制包的路径和权限"></a>2. 配置k3s二进制包的路径和权限</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/src/k3s /usr/local/bin/</span><br><span class="line">chmod <span class="number">755</span> /usr/local/bin/k3s</span><br></pre></td></tr></table></figure><h2 id="3-yum安装相关工具"><a href="#3-yum安装相关工具" class="headerlink" title="3. yum安装相关工具"></a>3. yum安装相关工具</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y container-selinux selinux-policy-base</span><br><span class="line">yum install -y /usr/local/src/k3s-selinux-<span class="number">0.2</span>-<span class="number">1.</span>el7_8.<span class="property">noarch</span>.<span class="property">rpm</span></span><br></pre></td></tr></table></figure><h2 id="4-执行k3s安装脚本"><a href="#4-执行k3s安装脚本" class="headerlink" title="4. 执行k3s安装脚本"></a>4. 执行k3s安装脚本</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="variable constant_">INSTALL_K3S_VERSION</span>=v1<span class="number">.21</span><span class="number">.2</span>+k3s1</span><br><span class="line"><span class="keyword">export</span> <span class="variable constant_">INSTALL_K3S_SKIP_DOWNLOAD</span>=<span class="literal">true</span></span><br><span class="line"><span class="keyword">export</span> <span class="variable constant_">INSTALL_K3S_EXEC</span>=<span class="string">&quot;--write-kubeconfig ~/.kube/config --cluster-cidr  172.16.0.0/12 --service-cidr  172.16.130.0/12&quot;</span></span><br><span class="line">sh /usr/local/src/k3s.<span class="property">sh</span></span><br></pre></td></tr></table></figure><h2 id="5-检查是否安装成功"><a href="#5-检查是否安装成功" class="headerlink" title="5. 检查是否安装成功"></a>5. 检查是否安装成功</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl status k3s</span><br><span class="line">kubectl get node</span><br><span class="line"># 等待所有服务处于<span class="title class_">Running</span>或<span class="title class_">Completed</span>状态</span><br><span class="line">kubectl get pod -A</span><br></pre></td></tr></table></figure><p>结果截图：<br><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91k3s%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/60ee34d1538c6.png"></p><h2 id="6-测试nginx服务"><a href="#6-测试nginx服务" class="headerlink" title="6. 测试nginx服务"></a>6. 测试nginx服务</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 创建测试nginx服务</span><br><span class="line">kubectl create -f /usr/local/src/nginx.<span class="property">yaml</span></span><br><span class="line"># 查看服务是否启动成功，nginx服务处于<span class="title class_">Running</span>状态的则表明都运行成功</span><br><span class="line">kubectl get pod -A</span><br></pre></td></tr></table></figure><p>结果截图：<br><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91k3s%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/60ee358c80d92.png"></p><p>通过浏览器访问：https:&#x2F;&#x2F;[server-ip]:32000</p><h1 id="k3s二进制文件地址"><a href="#k3s二进制文件地址" class="headerlink" title="k3s二进制文件地址"></a>k3s二进制文件地址</h1><p>下载地址：<a href="https://github.com/k3s-io/k3s/releases/download/v1.21.2+k3s1/k3s">https://github.com/k3s-io/k3s/releases/download/v1.21.2+k3s1/k3s</a></p><h1 id="k3s-selinux地址"><a href="#k3s-selinux地址" class="headerlink" title="k3s-selinux地址"></a>k3s-selinux地址</h1><p>下载网址：<a href="https://rpm.rancher.io/k3s/stable/common/centos/7/noarch/k3s-selinux-0.2-1.el7_8.noarch.rpm">https://rpm.rancher.io/k3s/stable/common/centos/7/noarch/k3s-selinux-0.2-1.el7_8.noarch.rpm</a></p><h1 id="k3s-sh文件内容"><a href="#k3s-sh文件内容" class="headerlink" title="k3s.sh文件内容"></a>k3s.sh文件内容</h1><p>下载网址：<a href="https://get.k3s.io/">https://get.k3s.io/</a></p><h1 id="nginx-yaml文件内容"><a href="#nginx-yaml文件内容" class="headerlink" title="nginx.yaml文件内容"></a>nginx.yaml文件内容</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">kind: Namespace</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: test-project</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: service-nginx-server</span><br><span class="line">  namespace: test-project</span><br><span class="line">  labels:</span><br><span class="line">    app: service-nginx-server</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - name: tcp-80</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80</span><br><span class="line">      nodePort: 32000</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-server</span><br><span class="line">  type: NodePort</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: deployment-nginx-server</span><br><span class="line">  namespace: test-project</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-server</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-server</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: container-nginx-server</span><br><span class="line">          image: &#x27;nginx:1.20.1-alpine&#x27;</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 80</span><br><span class="line">              protocol: TCP</span><br></pre></td></tr></table></figure><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;本文针对版本v1-21-2-k3s1&quot;&gt;&lt;a href=&quot;#本文针对版本v1-21-2-k3s1&quot; class=&quot;headerlink&quot; title=&quot;本文针对版本v1.21.2+k3s1&quot;&gt;&lt;/a&gt;本文针对版本v1.21.2+k3s1&lt;/h1&gt;&lt;h1 id=&quot;官</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="K3S" scheme="https://gaussli.com/categories/tech/container/k3s/"/>
    
    
    <category term="脚本安装" scheme="https://gaussli.com/tags/%E8%84%9A%E6%9C%AC%E5%AE%89%E8%A3%85/"/>
    
    <category term="Container" scheme="https://gaussli.com/tags/container/"/>
    
    <category term="K3S" scheme="https://gaussli.com/tags/k3s/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes中openebs数据迁移</title>
    <link href="https://gaussli.com/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%B8%ADopenebs%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    <id>https://gaussli.com/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%B8%ADopenebs%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/</id>
    <published>2021-07-26T15:01:24.000Z</published>
    <updated>2021-07-26T15:05:37.069Z</updated>
    
    <content type="html"><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>openebs作为Kubernetes持久层使用的时候，数据只会存在Kubernetes集群中某个节点中，节点间的数据不会自动共享，这也是导致Kubesphere官方说openebs建议不在生产环境下使用的原因。<br>这种情况下，如果某个Node节点从集群中移除后，该Node节点中的数据就需要手动同步到其他节点中。</p><h1 id="现象发现"><a href="#现象发现" class="headerlink" title="现象发现"></a>现象发现</h1><h2 id="1-Node节点移除后，某pod一直处于Pending状态"><a href="#1-Node节点移除后，某pod一直处于Pending状态" class="headerlink" title="1. Node节点移除后，某pod一直处于Pending状态"></a>1. Node节点移除后，某pod一直处于Pending状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -A |grep Pending</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%B8%ADopenebs%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/60ed40e418af3.png"></p><h2 id="2-查看pod的describe信息"><a href="#2-查看pod的describe信息" class="headerlink" title="2. 查看pod的describe信息"></a>2. 查看pod的describe信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod [pending-pod-name] -n [pending-pod-namespace]</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%B8%ADopenebs%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/60ed41608e44a.png"><br>结果表明：该POD有Node节点亲和性（affinity）问题。</p><h2 id="3-查看pod的yaml文件内容"><a href="#3-查看pod的yaml文件内容" class="headerlink" title="3. 查看pod的yaml文件内容"></a>3. 查看pod的yaml文件内容</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod [pending-pod-name] -n [pending-pod-namespace] -oyaml</span><br></pre></td></tr></table></figure><p>进一步分析：本身POD是没有进行亲和性（affinity）配置的，那么和POD有关的额外资源，就是持久层资源（pvc、pv）</p><h2 id="4-查看对应持久层资源（pvc、pv）"><a href="#4-查看对应持久层资源（pvc、pv）" class="headerlink" title="4. 查看对应持久层资源（pvc、pv）"></a>4. 查看对应持久层资源（pvc、pv）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pvc [pvc-name] -n [pending-pod-namespace] -oyaml</span><br><span class="line">kubectl get pv [pv-name] -oyaml</span><br></pre></td></tr></table></figure><h2 id="5-最后能发现，openebs的pv是需要指定Node节点亲和性的"><a href="#5-最后能发现，openebs的pv是需要指定Node节点亲和性的" class="headerlink" title="5. 最后能发现，openebs的pv是需要指定Node节点亲和性的"></a>5. 最后能发现，openebs的pv是需要指定Node节点亲和性的</h2><p>而如果对应的Node节点被移除了，那么自然这个pv肯定是运行失败了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 例子</span><br><span class="line">nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io/hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - k8s-node3</span><br></pre></td></tr></table></figure><h1 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h1><p>问题找到了，那么就有了解决思路：</p><ol><li>把已移除节点中旧PV已存储的数据内容迁移到集群中尚存在的的某节点对应目录上</li><li>保存PVC、PV的yaml文件</li><li>删除掉PVC和PV</li><li>修改PV的节点亲和性</li><li>重新部署PVC和PV</li></ol><h1 id="解决流程"><a href="#解决流程" class="headerlink" title="解决流程"></a>解决流程</h1><h2 id="把已移除节点中旧PV已存储的数据（目录-var-openebs-local-）迁移到Master节点上（目录：-var-openebs-local-）"><a href="#把已移除节点中旧PV已存储的数据（目录-var-openebs-local-）迁移到Master节点上（目录：-var-openebs-local-）" class="headerlink" title="把已移除节点中旧PV已存储的数据（目录&#x2F;var&#x2F;openebs&#x2F;local&#x2F;）迁移到Master节点上（目录：&#x2F;var&#x2F;openebs&#x2F;local&#x2F;）"></a>把已移除节点中旧PV已存储的数据（目录&#x2F;var&#x2F;openebs&#x2F;local&#x2F;）迁移到Master节点上（目录：&#x2F;var&#x2F;openebs&#x2F;local&#x2F;）</h2><p>过程略</p><h2 id="保存PVC、PV的yaml文件"><a href="#保存PVC、PV的yaml文件" class="headerlink" title="保存PVC、PV的yaml文件"></a>保存PVC、PV的yaml文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get -n [namespace] pvc [pvc-name] -oyaml &gt; pvc.yaml</span><br><span class="line">kubectl get -n [namespace] pv [pv-name] -oyaml &gt; pv.yaml</span><br></pre></td></tr></table></figure><h2 id="删除PVC和PV"><a href="#删除PVC和PV" class="headerlink" title="删除PVC和PV"></a>删除PVC和PV</h2><p>默认情况下，PVC和PV被正在使用是不能直接删除的，删除会一直使PV处于Terminating状态，所以先给PVC加一个元数据，载进行删除</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch -n [namespace] pvc [pvc-name] -p <span class="string">&#x27;&#123;&quot;metadata&quot;:&#123;&quot;finalizers&quot;:null&#125;&#125;&#x27;</span></span><br><span class="line">kubectl delete -n [namespace] pvc [pvc-name]</span><br><span class="line">kubectl delete -n [namespace] pv [pv-name]</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%B8%ADopenebs%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/60ed50ef5ea20.png"></p><h2 id="修改PV的节点亲和性和删掉和PVC的关联信息"><a href="#修改PV的节点亲和性和删掉和PVC的关联信息" class="headerlink" title="修改PV的节点亲和性和删掉和PVC的关联信息"></a>修改PV的节点亲和性和删掉和PVC的关联信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改pv.yaml</span></span><br><span class="line">vi pv.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除以下内容</span></span><br><span class="line"><span class="comment">#claimRef:</span></span><br><span class="line"><span class="comment">#    apiVersion: v1</span></span><br><span class="line"><span class="comment">#    kind: PersistentVolumeClaim</span></span><br><span class="line"><span class="comment">#    name: data-elasticsearch-logging-data-0</span></span><br><span class="line"><span class="comment">#    namespace: kubesphere-logging-system</span></span><br><span class="line"><span class="comment">#    resourceVersion: &quot;13881&quot;</span></span><br><span class="line"><span class="comment">#    uid: f15f1581-f8ae-452b-9825-c28c1cf34f7b</span></span><br><span class="line">nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io/hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          <span class="comment"># 修改以下内容</span></span><br><span class="line">          <span class="comment"># k8s-node3改成k8s-master1，改成集群中存在可用的节点名称</span></span><br><span class="line">          - k8s-master1</span><br></pre></td></tr></table></figure><h2 id="重新部署PVC和PV"><a href="#重新部署PVC和PV" class="headerlink" title="重新部署PVC和PV"></a>重新部署PVC和PV</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f pv.yaml</span><br><span class="line">kubectl create -f pvc.yaml</span><br></pre></td></tr></table></figure><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h1&gt;&lt;p&gt;openebs作为Kubernetes持久层使用的时候，数据只会存在Kubernetes集群中某个节点中，节点间的数据不会自</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="Container" scheme="https://gaussli.com/tags/container/"/>
    
    <category term="OpenEBS" scheme="https://gaussli.com/tags/openebs/"/>
    
    <category term="数据迁移" scheme="https://gaussli.com/tags/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes证书过期问题处理</title>
    <link href="https://gaussli.com/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E8%AF%81%E4%B9%A6%E8%BF%87%E6%9C%9F%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"/>
    <id>https://gaussli.com/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E8%AF%81%E4%B9%A6%E8%BF%87%E6%9C%9F%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/</id>
    <published>2021-07-26T14:57:33.000Z</published>
    <updated>2021-07-26T15:01:13.692Z</updated>
    
    <content type="html"><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>Kubernetes稳定运行了一年，突然Kubesphere中任何和K8S资源相关的操作都失效了，而且发现kubectl命令也出错了，报错如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Unable to connect to the server: x509: certificate has expired or is not yet valid</span><br><span class="line">openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text |grep &#x27; Not &#x27;</span><br></pre></td></tr></table></figure><p>原因是Kubernetes的证书默认过期有效期为1年，查看证书有效期命令如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm alpha certs check-expiration</span><br></pre></td></tr></table></figure><p>查看结果例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[check-expiration] Reading configuration from the cluster...</span><br><span class="line">[check-expiration] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -oyaml&#x27;</span><br><span class="line"></span><br><span class="line">CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED</span><br><span class="line">admin.conf                 Jul 08, 2022 01:40 UTC   364d                                    no      </span><br><span class="line">apiserver                  Jul 08, 2022 01:40 UTC   364d            ca                      no      </span><br><span class="line">apiserver-etcd-client      Jul 08, 2022 01:40 UTC   364d            etcd-ca                 no      </span><br><span class="line">apiserver-kubelet-client   Jul 08, 2022 01:40 UTC   364d            ca                      no      </span><br><span class="line">controller-manager.conf    Jul 08, 2022 01:40 UTC   364d                                    no      </span><br><span class="line">etcd-healthcheck-client    Jul 08, 2022 01:40 UTC   364d            etcd-ca                 no      </span><br><span class="line">etcd-peer                  Jul 08, 2022 01:40 UTC   364d            etcd-ca                 no      </span><br><span class="line">etcd-server                Jul 08, 2022 01:40 UTC   364d            etcd-ca                 no      </span><br><span class="line">front-proxy-client         Jul 08, 2022 01:40 UTC   364d            front-proxy-ca          no      </span><br><span class="line">scheduler.conf             Jul 08, 2022 01:40 UTC   364d                                    no      </span><br><span class="line"></span><br><span class="line">CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED</span><br><span class="line">ca                      Jul 05, 2030 08:16 UTC   8y              no      </span><br><span class="line">etcd-ca                 Jul 05, 2030 08:16 UTC   8y              no      </span><br><span class="line">front-proxy-ca          Jul 05, 2030 08:16 UTC   8y              no</span><br></pre></td></tr></table></figure><h1 id="解决方案（更新证书有效期）"><a href="#解决方案（更新证书有效期）" class="headerlink" title="解决方案（更新证书有效期）"></a>解决方案（更新证书有效期）</h1><h2 id="1-备份证书"><a href="#1-备份证书" class="headerlink" title="1. 备份证书"></a>1. 备份证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> -rp /etc/kubernetes /etc/kubernetes.bak.[<span class="built_in">date</span>]</span><br></pre></td></tr></table></figure><h2 id="2-更新所有证书"><a href="#2-更新所有证书" class="headerlink" title="2. 更新所有证书"></a>2. 更新所有证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm alpha certs renew all</span><br></pre></td></tr></table></figure><p><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E8%AF%81%E4%B9%A6%E8%BF%87%E6%9C%9F%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/60ed3268f3349.png"></p><h2 id="3-复制admin-conf到-kube-config，kubectl需要用到该文件"><a href="#3-复制admin-conf到-kube-config，kubectl需要用到该文件" class="headerlink" title="3. 复制admin.conf到~&#x2F;.kube&#x2F;config，kubectl需要用到该文件"></a>3. 复制admin.conf到~&#x2F;.kube&#x2F;config，kubectl需要用到该文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> -rp ~/.kube ~/.kube.bak.[<span class="built_in">date</span>]</span><br><span class="line"><span class="built_in">cp</span> /etc/kubernetes/admin.conf ~/.kube/config</span><br></pre></td></tr></table></figure><p><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E8%AF%81%E4%B9%A6%E8%BF%87%E6%9C%9F%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/60ed3346327db.png"></p><h2 id="4-重启kube-apiserver、kube-controller-manager、kube-scheduler和etcd服务或直接重启docker"><a href="#4-重启kube-apiserver、kube-controller-manager、kube-scheduler和etcd服务或直接重启docker" class="headerlink" title="4. 重启kube-apiserver、kube-controller-manager、kube-scheduler和etcd服务或直接重启docker"></a>4. 重启kube-apiserver、kube-controller-manager、kube-scheduler和etcd服务或直接重启docker</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h1&gt;&lt;p&gt;Kubernetes稳定运行了一年，突然Kubesphere中任何和K8S资源相关的操作都失效了，而且发现kubectl命令</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="Container" scheme="https://gaussli.com/tags/container/"/>
    
    <category term="证书过期" scheme="https://gaussli.com/tags/%E8%AF%81%E4%B9%A6%E8%BF%87%E6%9C%9F/"/>
    
  </entry>
  
  <entry>
    <title>【容器化】Kubernetes优雅新增或移除节点</title>
    <link href="https://gaussli.com/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BC%98%E9%9B%85%E6%96%B0%E5%A2%9E%E6%88%96%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9/"/>
    <id>https://gaussli.com/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BC%98%E9%9B%85%E6%96%B0%E5%A2%9E%E6%88%96%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9/</id>
    <published>2021-07-26T14:41:18.000Z</published>
    <updated>2021-07-26T14:44:57.946Z</updated>
    
    <content type="html"><![CDATA[<h1 id="新增节点"><a href="#新增节点" class="headerlink" title="新增节点"></a>新增节点</h1><h3 id="1-集群内所有节点的hosts文件加上新节点解析"><a href="#1-集群内所有节点的hosts文件加上新节点解析" class="headerlink" title="1. 集群内所有节点的hosts文件加上新节点解析"></a>1. 集群内所有节点的hosts文件加上新节点解析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入hosts文件编辑</span></span><br><span class="line">vi /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment">## 在文件中加入下面内容</span></span><br><span class="line">[new-node-ip] [new-node-hostname]</span><br></pre></td></tr></table></figure><h3 id="2-进入Master节点，查看当前是否存在可用Token，没有任何输出说明当前没有可用Token"><a href="#2-进入Master节点，查看当前是否存在可用Token，没有任何输出说明当前没有可用Token" class="headerlink" title="2. 进入Master节点，查看当前是否存在可用Token，没有任何输出说明当前没有可用Token"></a>2. 进入Master节点，查看当前是否存在可用Token，没有任何输出说明当前没有可用Token</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token list</span><br></pre></td></tr></table></figure><h3 id="3-创建Token"><a href="#3-创建Token" class="headerlink" title="3. 创建Token"></a>3. 创建Token</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create</span><br></pre></td></tr></table></figure><p>结果截图：<br><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BC%98%E9%9B%85%E6%96%B0%E5%A2%9E%E6%88%96%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9/60ece116f174c.png"></p><h3 id="4-再次查看可用Token，可查看Token的一些信息"><a href="#4-再次查看可用Token，可查看Token的一些信息" class="headerlink" title="4. 再次查看可用Token，可查看Token的一些信息"></a>4. 再次查看可用Token，可查看Token的一些信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token list</span><br></pre></td></tr></table></figure><p>结果截图：<br><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BC%98%E9%9B%85%E6%96%B0%E5%A2%9E%E6%88%96%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9/60ece15c8dbae.png"></p><h3 id="5-根据ca的公钥证书数据计算出hash值"><a href="#5-根据ca的公钥证书数据计算出hash值" class="headerlink" title="5. 根据ca的公钥证书数据计算出hash值"></a>5. 根据ca的公钥证书数据计算出hash值</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -pubkey | openssl rsa -pubin -outform DER 2&gt;/dev/null | sha256sum | cut -d&#x27; &#x27; -f1</span><br></pre></td></tr></table></figure><p>结果截图：<br><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BC%98%E9%9B%85%E6%96%B0%E5%A2%9E%E6%88%96%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9/60ece296c990b.png"></p><h3 id="6-新节点安装kubectl、kubeadm、kubelet，版本需和Master的一致"><a href="#6-新节点安装kubectl、kubeadm、kubelet，版本需和Master的一致" class="headerlink" title="6. 新节点安装kubectl、kubeadm、kubelet，版本需和Master的一致"></a>6. 新节点安装kubectl、kubeadm、kubelet，版本需和Master的一致</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install kubelet-1.17.3 kubeadm-1.17.3 kubectl-1.17.3</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line">systemctl start kubelet</span><br></pre></td></tr></table></figure><h3 id="7-把新节点加入到集群中，其中使用到上述获取的Token和ca证书的hash值"><a href="#7-把新节点加入到集群中，其中使用到上述获取的Token和ca证书的hash值" class="headerlink" title="7. 把新节点加入到集群中，其中使用到上述获取的Token和ca证书的hash值"></a>7. 把新节点加入到集群中，其中使用到上述获取的Token和ca证书的hash值</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm <span class="built_in">join</span> &lt;master-ip&gt;:6443 --node-name [new-node-hostname] --token kklhin.swv9pvue5jncxzqs --discovery-token-ca-cert-hash sha256:7e0f436144520310a988005261894d4c82c36c99c0db9e71e4daac5546d5f159</span><br></pre></td></tr></table></figure><h1 id="移除节点"><a href="#移除节点" class="headerlink" title="移除节点"></a>移除节点</h1><h3 id="1-进入到Master节点，驱逐待移除节点上的pod"><a href="#1-进入到Master节点，驱逐待移除节点上的pod" class="headerlink" title="1. 进入到Master节点，驱逐待移除节点上的pod"></a>1. 进入到Master节点，驱逐待移除节点上的pod</h3><p>参数说明</p><ul><li>–force<br>当一些pod不是经 ReplicationController, ReplicaSet, Job, DaemonSet 或者 StatefulSet 管理的时候<br>就需要用–force来强制执行 (例如:kube-proxy)</li><li>–ignore-daemonsets<br>无视DaemonSet管理下的Pod</li><li>–delete-local-data<br>如果有mount local volumn的pod，会强制杀掉该pod并把料清除掉<br>另外如果跟本身的配置讯息有冲突时，drain就不会执行</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain [node-name] --force --ignore-daemonsets --delete-local-data</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BC%98%E9%9B%85%E6%96%B0%E5%A2%9E%E6%88%96%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9/60ecf0f334e65.png"><br><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BC%98%E9%9B%85%E6%96%B0%E5%A2%9E%E6%88%96%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9/60ecf108e9659.png"></p><h3 id="2-删除节点"><a href="#2-删除节点" class="headerlink" title="2. 删除节点"></a>2. 删除节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete node [node-name]</span><br></pre></td></tr></table></figure><p><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BC%98%E9%9B%85%E6%96%B0%E5%A2%9E%E6%88%96%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9/60ecf1777808b.png"></p><h3 id="3-进入待删除节点，重置节点"><a href="#3-进入待删除节点，重置节点" class="headerlink" title="3. 进入待删除节点，重置节点"></a>3. 进入待删除节点，重置节点</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure><h3 id="4-（可选）移除待删除节点的Kubernetes网络配置"><a href="#4-（可选）移除待删除节点的Kubernetes网络配置" class="headerlink" title="4. （可选）移除待删除节点的Kubernetes网络配置"></a>4. （可选）移除待删除节点的Kubernetes网络配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看网络配置</span><br><span class="line">ip a</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BC%98%E9%9B%85%E6%96%B0%E5%A2%9E%E6%88%96%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9/60ee322e1ce39.png"><br>发现有两个Kubernetes的网络配置（flannel.1和cni0）是已无用网络配置，对其进行下线及删除</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ifconfig cni0 down</span><br><span class="line">ifconfig flannel.1 down</span><br><span class="line">ip link delete cni0</span><br><span class="line">ip link delete flannel.1</span><br><span class="line">ip a</span><br></pre></td></tr></table></figure><p>结果截图<br><img src="/2021/07/26/%E3%80%90%E5%AE%B9%E5%99%A8%E5%8C%96%E3%80%91kubernetes%E4%BC%98%E9%9B%85%E6%96%B0%E5%A2%9E%E6%88%96%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9/60ee32666c273.png"></p><p>(•̀ᴗ•́)و ̑̑</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;新增节点&quot;&gt;&lt;a href=&quot;#新增节点&quot; class=&quot;headerlink&quot; title=&quot;新增节点&quot;&gt;&lt;/a&gt;新增节点&lt;/h1&gt;&lt;h3 id=&quot;1-集群内所有节点的hosts文件加上新节点解析&quot;&gt;&lt;a href=&quot;#1-集群内所有节点的hosts文件加上新节</summary>
      
    
    
    
    <category term="Tech" scheme="https://gaussli.com/categories/tech/"/>
    
    <category term="Container" scheme="https://gaussli.com/categories/tech/container/"/>
    
    <category term="Kubernetes" scheme="https://gaussli.com/categories/tech/container/kubernetes/"/>
    
    
    <category term="Kubernetes" scheme="https://gaussli.com/tags/kubernetes/"/>
    
    <category term="Node" scheme="https://gaussli.com/tags/node/"/>
    
    <category term="Container" scheme="https://gaussli.com/tags/container/"/>
    
    <category term="优雅" scheme="https://gaussli.com/tags/%E4%BC%98%E9%9B%85/"/>
    
    <category term="节点" scheme="https://gaussli.com/tags/%E8%8A%82%E7%82%B9/"/>
    
  </entry>
  
</feed>
